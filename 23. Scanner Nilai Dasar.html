<script>
        // URL CSV (Dengan Timestamp Anti-Cache biar update terus)
        const baseUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGkIRI-_XNlA7-5YP1amp9axQdYbGFLERIted9INYCDKpFa8AxtJ-qwVMf9kFLB-kLcmUoJPzCmend/pub?gid=326493804&single=true&output=csv';
        const csvUrl = baseUrl + '&t=' + new Date().getTime();

        let dbData = [];

        // INIT
        async function loadDB() {
            const status = document.getElementById('dbStatus');
            try {
                const res = await fetch(csvUrl);
                const text = await res.text();
                parseCSV(text);
                
                // UPDATE STATUS DENGAN JUMLAH ITEM
                status.innerText = "DATABASE ONLINE (" + dbData.length + " ITEM)";
                status.style.borderColor = "#00ff88";
                status.style.color = "#00ff88";
                
                // Update Tombol List juga
                document.querySelector('.list-btn span:last-child').innerText = "[TOTAL: " + dbData.length + "]";
                
            } catch (err) {
                console.error(err);
                status.innerText = "OFFLINE MODE";
                status.style.borderColor = "#ff2a6d";
                status.style.color = "#ff2a6d";
            }
        }

        function parseCSV(text) {
            const rows = text.split('\n').slice(1); // Skip header
            dbData = rows.map(row => {
                const cols = parseRow(row);
                if(cols.length < 2) return null;
                
                let stats = cols[2] || "";
                let energy = "-", nutrisi = "-", fungsi = "-";

                // Parsing Pintar (Cari kata kunci)
                if(stats.includes(':')) {
                    let parts = stats.split(';');
                    parts.forEach(p => {
                        let [k, v] = p.split(':');
                        if(k && v) {
                            k = k.trim().toLowerCase();
                            if(k.includes('energi') || k.includes('kalori')) energy = v.trim();
                            else if(k.includes('nutrisi') || k.includes('gizi')) nutrisi = v.trim();
                            else if(k.includes('fungsi') || k.includes('manfaat')) fungsi = v.trim();
                        }
                    });
                } else {
                    nutrisi = stats; 
                }

                return {
                    nama: cols[0].trim(),
                    r: cols[1] ? cols[1].trim() : "Unknown",
                    e: energy,
                    n: nutrisi,
                    f: fungsi,
                    d: cols[3] ? cols[3].trim() : "No data available."
                };
            }).filter(item => item !== null);
            
            renderList();
        }

        function parseRow(row) {
            let res = [];
            let cur = '';
            let inQuote = false;
            for(let c of row) {
                if(c === '"') { inQuote = !inQuote; }
                else if(c === ',' && !inQuote) { res.push(cur); cur = ''; }
                else { cur += c; }
            }
            res.push(cur);
            return res;
        }

        function renderList() {
            const list = document.getElementById('listContent');
            list.innerHTML = "";
            
            // SORTING A-Z (Ini yang bikin Udang ada di bawah)
            dbData.sort((a,b) => a.nama.localeCompare(b.nama));
            
            dbData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'db-item';
                // Tampilkan Rank di sebelah kanan
                div.innerHTML = `<span>${item.nama}</span> <span style="font-size:0.7rem; color:#00bcd4; border:1px solid #00bcd4; padding:2px 5px; border-radius:4px;">${item.r}</span>`;
                div.onclick = () => {
                    document.getElementById('searchInput').value = item.nama;
                    toggleList();
                    scanItem();
                };
                list.appendChild(div);
            });
        }

        function toggleList() {
            const m = document.getElementById('listModal');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleEnter(e) {
            if(e.key === 'Enter') scanItem();
        }

        function scanItem() {
            const q = document.getElementById('searchInput').value.toLowerCase().trim();
            if(!q) return;

            // Cari item (case insensitive)
            const item = dbData.find(i => i.nama.toLowerCase() === q) || 
                         dbData.find(i => i.nama.toLowerCase().includes(q));

            if(item) {
                showResult(item);
            } else {
                alert("Barang '" + q + "' belum ada di database.");
            }
        }

        function showResult(data) {
            document.getElementById('rName').innerText = data.nama;
            document.getElementById('rClass').innerText = data.r;
            document.getElementById('rEnergy').innerText = data.e;
            document.getElementById('rNutrisi').innerText = data.n;
            document.getElementById('rFungsi').innerText = data.f;
            document.getElementById('rDesc').innerText = `"${data.d}"`;
            document.getElementById('resCard').style.display = 'block';
        }

        function closeCard() {
            document.getElementById('resCard').style.display = 'none';
            document.getElementById('searchInput').value = "";
        }

        loadDB();
    </script>
