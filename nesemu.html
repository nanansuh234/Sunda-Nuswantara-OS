<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunda Retro NES Station V2</title>
    <script type="text/javascript" src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            user-select: none;
        }

        h1 { text-shadow: 2px 2px #ff0055; margin-bottom: 5px; }
        p { color: #888; font-size: 0.8rem; margin-top: 0; }

        /* --- TV CONTAINER --- */
        .tv-frame {
            position: relative;
            width: 800px;
            height: 630px;
            background-image: url('tv.png'); /* Pastikan ada file tv.png */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-bottom: 20px;
            z-index: 10;
            transition: transform 0.2s;
        }

        /* Efek saat drag file */
        .tv-frame.drag-active {
            transform: scale(1.02);
            filter: drop-shadow(0 0 20px #00ff00);
        }

        /* --- LAYAR (CANVAS) --- */
        #nes-canvas {
            position: absolute;
            top: 14%; left: 17.5%; width: 65%; height: 70%;
            background: #000;
            image-rendering: pixelated;
            border-radius: 5% / 50%;
            z-index: 5;
        }

        /* Pesan di layar TV */
        .osd-message {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #0f0;
            font-size: 1.2rem;
            text-align: center;
            z-index: 20;
            text-shadow: 0 0 5px #000;
            pointer-events: none;
            width: 60%;
        }

        /* Efek Scanlines & Glare */
        .scanlines {
            position: absolute;
            top: 14%; left: 17.5%; width: 65%; height: 70%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 6;
            border-radius: 5% / 50%;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- UI CARTRIDGE --- */
        .console-deck {
            background: #333;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #555;
            width: 80%;
            max-width: 700px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .cartridge-slot { flex: 1; min-width: 250px; }

        .game-btn {
            background: linear-gradient(to bottom, #777, #555);
            border: 2px solid #222;
            border-bottom: 5px solid #111;
            color: #fff;
            padding: 10px 15px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            margin-bottom: 5px;
            position: relative;
        }

        .game-btn:active { transform: translateY(3px); border-bottom: 2px solid #111; }
        .game-btn::before { content: '‚ñí'; color: gold; margin-right: 10px; }

        /* --- CONTROLS UI --- */
        .controls-panel {
            flex: 1; min-width: 250px;
            background: #222; padding: 10px; border-radius: 5px; font-size: 0.8rem;
        }
        .key-row { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding: 3px 0; }
        .key-val { color: #0f0; }

        /* Hidden Input */
        #file-input { display: none; }

    </style>
</head>
<body>

    <h1>SUNDA RETRO STATION V2</h1>
    <p>Drag & Drop file .NES ke layar TV untuk main!</p>

    <div class="tv-frame" id="tv-zone">
        <canvas id="nes-canvas" width="256" height="240"></canvas>
        <div class="scanlines"></div>
        <div id="osd" class="osd-message">
            NO SIGNAL<br><br>
            <span style="font-size:0.8rem; color:#888;">Tarik File Game (.nes) ke sini<br>atau Klik Tombol di Bawah</span>
        </div>
    </div>

    <div class="console-deck">
        <div class="cartridge-slot">
            <h3 style="margin:0 0 10px 0; border-bottom: 1px solid #777;">GAME LIBRARY</h3>
            
            <button class="game-btn" onclick="tryLoad('Chip n Dale Rescue Rangers 2 (U) [!].nes')">Chip 'n Dale 2</button>
            <button class="game-btn" onclick="tryLoad('RoboCop 3 (U) [!p].nes')">RoboCop 3</button>
            <button class="game-btn" onclick="tryLoad('TMNT.NES')">TMNT (Ninja Turtles)</button>
            
            <button class="game-btn" style="background:#444; color:#aaa; margin-top:10px;" onclick="document.getElementById('file-input').click()">üìÅ BUKA FILE MANUAL...</button>
            <input type="file" id="file-input" accept=".nes">
        </div>

        <div class="controls-panel">
            <h3 style="margin:0 0 10px 0; color: #0f0;">CONTROLS</h3>
            <div class="key-row"><span>Gerak</span> <span class="key-val">Panah</span></div>
            <div class="key-row"><span>A (Lompat)</span> <span class="key-val">X</span></div>
            <div class="key-row"><span>B (Serang)</span> <span class="key-val">Z</span></div>
            <div class="key-row"><span>Start</span> <span class="key-val">Enter</span></div>
            <div class="key-row"><span>Select</span> <span class="key-val">Shift</span></div>
            <div class="key-row"><span>Reset</span> <span class="key-val">R</span></div>
            <div style="margin-top:10px; color:yellow; font-size:0.7rem;">
                *Klik layar dulu agar suara aktif.
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP AUDIO & NES ---
        var SCREEN_WIDTH = 256;
        var SCREEN_HEIGHT = 240;
        var FRAMEBUFFER_SIZE = SCREEN_WIDTH * SCREEN_HEIGHT;

        var canvas = document.getElementById('nes-canvas');
        var ctx = canvas.getContext('2d');
        var imageData = ctx.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
        var buf32 = new Uint32Array(imageData.data.buffer);
        var buf8 = new Uint8ClampedArray(buf32.buffer);

        // Audio Context Global
        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        var scriptProcessor = null;
        var audioBuffer = []; // Ring buffer sederhana untuk audio
        var BUFFER_LIMIT = 4096 * 4;

        var nes = new jsnes.NES({
            onFrame: function(buffer) {
                var i = 0;
                for (var y = 0; y < SCREEN_HEIGHT; ++y) {
                    for (var x = 0; x < SCREEN_WIDTH; ++x) {
                        var pixel = buffer[i++];
                        buf32[y * SCREEN_WIDTH + x] = 
                            (0xFF000000) | 
                            ((pixel & 0xFF) << 16) | 
                            ((pixel & 0xFF00) << 0) | 
                            ((pixel & 0xFF0000) >> 16);
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            },
            onAudioSample: function(left, right) {
                // Masukkan sample audio dari JSNES ke buffer kita
                if (audioBuffer.length < BUFFER_LIMIT) {
                    audioBuffer.push(left, right);
                }
            }
        });

        // --- 2. AUDIO ENGINE (FIXED) ---
        function initAudioEngine() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            if (!scriptProcessor) {
                // Buffer size 4096 memberikan balance antara latency dan kestabilan
                scriptProcessor = audioCtx.createScriptProcessor(4096, 0, 2);
                scriptProcessor.onaudioprocess = function(e) {
                    var outputL = e.outputBuffer.getChannelData(0);
                    var outputR = e.outputBuffer.getChannelData(1);
                    
                    // Isi buffer audio browser dengan data dari JSNES
                    for (var i = 0; i < 4096; i++) {
                        if (audioBuffer.length >= 2) {
                            outputL[i] = audioBuffer.shift();
                            outputR[i] = audioBuffer.shift();
                        } else {
                            // Kalau buffer kosong (lag), isi silence
                            outputL[i] = 0;
                            outputR[i] = 0;
                        }
                    }
                };
                scriptProcessor.connect(audioCtx.destination);
            }
        }

        // --- 3. GAME LOOP ---
        function onAnimationFrame() {
            window.requestAnimationFrame(onAnimationFrame);
            // Jalankan frame NES
            // Kita panggil nes.frame() untuk generate video & audio
            // Audio akan masuk ke onAudioSample -> audioBuffer -> ScriptProcessor -> Speaker
            nes.frame();
        }

        // --- 4. INPUT HANDLING (DRAG & DROP + BUTTON) ---
        
        // Drag & Drop Visuals
        var tvZone = document.getElementById('tv-zone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            tvZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        tvZone.addEventListener('dragenter', () => tvZone.classList.add('drag-active'));
        tvZone.addEventListener('dragleave', () => tvZone.classList.remove('drag-active'));
        
        tvZone.addEventListener('drop', (e) => {
            tvZone.classList.remove('drag-active');
            var dt = e.dataTransfer;
            var files = dt.files;
            handleFiles(files);
        });

        document.getElementById('file-input').addEventListener('change', function(e) {
            handleFiles(this.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                var file = files[0];
                if (file.name.toLowerCase().endsWith('.nes')) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        bootGame(this.result, file.name);
                    };
                    reader.readAsBinaryString(file);
                } else {
                    alert("Bro, itu bukan kaset Nintendo (.nes)!");
                }
            }
        }

        // Fungsi Load Game Canggih (Coba Direct dulu, kalau gagal minta Manual)
        function tryLoad(filename) {
            document.getElementById('osd').innerText = "SEARCHING CARTRIDGE...";
            
            // Coba fetch (hanya jalan kalau pakai Local Server)
            fetch(filename)
                .then(response => {
                    if (!response.ok) throw new Error("Gak ketemu");
                    return response.arrayBuffer();
                })
                .then(buffer => {
                    // Convert ArrayBuffer to BinaryString for JSNES
                    var data = new Uint8Array(buffer);
                    var binStr = "";
                    for(var i=0; i<data.length; i++) binStr += String.fromCharCode(data[i]);
                    bootGame(binStr, filename);
                })
                .catch(err => {
                    // Fallback kalau gagal fetch (karena CORS / file://)
                    console.log("Direct load gagal (CORS/No Server). Fallback ke manual.");
                    alert("Gagal load otomatis (Browser Security). \n\nSilakan pilih file '" + filename + "' secara manual dari komputermu.");
                    document.getElementById('file-input').click();
                    document.getElementById('osd').innerHTML = "INSERT DISK<br><span style='font-size:0.8rem'>Waiting for file...</span>";
                });
        }

        function bootGame(binaryString, name) {
            try {
                nes.loadROM(binaryString);
                initAudioEngine(); // Nyalakan mesin suara
                window.requestAnimationFrame(onAnimationFrame); // Mulai loop
                
                document.getElementById('osd').style.display = 'none'; // Sembunyikan pesan OSD
                console.log("Booting: " + name);
            } catch(e) {
                alert("Kaset rusak bro (ROM Error).");
            }
        }

        // --- 5. KEYBOARD MAP ---
        document.addEventListener('keydown', function(e) {
            var keyMap = {
                'x': 0, 'z': 1, 'Shift': 2, 'Enter': 3, // A, B, Select, Start
                'ArrowUp': 4, 'ArrowDown': 5, 'ArrowLeft': 6, 'ArrowRight': 7
            };
            if(e.key === 'r' || e.key === 'R') nes.reset();
            
            if (keyMap.hasOwnProperty(e.key)) {
                nes.buttonDown(1, keyMap[e.key]);
                initAudioEngine(); // Pastikan audio nyala pas pencet tombol
            }
        });

        document.addEventListener('keyup', function(e) {
            var keyMap = {
                'x': 0, 'z': 1, 'Shift': 2, 'Enter': 3,
                'ArrowUp': 4, 'ArrowDown': 5, 'ArrowLeft': 6, 'ArrowRight': 7
            };
            if (keyMap.hasOwnProperty(e.key)) {
                nes.buttonUp(1, keyMap[e.key]);
            }
        });

    </script>
</body>
</html>
