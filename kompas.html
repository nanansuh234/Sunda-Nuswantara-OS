<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigasi Taktis v2 - Nuswantara OS</title>
    <style>
        /* --- STYLE DASAR --- */
        body {
            background-color: #050505; /* Lebih gelap */
            color: #00ff88;
            font-family: 'Consolas', 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0; text-align: center; overflow-x: hidden;
        }
        #pc-warning { display: none; background: #330000; border: 1px solid red; color: #ffcccc; padding: 10px; margin: 20px; font-size: 0.8rem; }
        #start-btn {
            padding: 20px 40px; font-size: 1.2rem; background: #001a0d; color: #00ff88;
            border: 2px solid #00ff88; cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3); transition: 0.3s;
        }
        #start-btn:active { background: #00ff88; color: black; }
        .compass-ui { display: none; width: 100%; max-width: 400px; }

        /* --- KOMPAS TAKTIS BARU --- */
        .compass-ring {
            width: 300px; height: 300px; margin: 0 auto 30px;
            border: 4px solid #333; border-radius: 50%; position: relative;
            background: #000;
            box-shadow: inset 0 0 50px rgba(0,255,136,0.1), 0 0 20px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        /* Container yang berputar */
        #rotating-container {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efek pegas halus */
        }

        /* Lapisan 1: Garis-garis Derajat Halus (The "Garis-Garis") */
        .tick-marks {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-conic-gradient(
                from 0deg,
                rgba(0, 255, 136, 0.4) 0deg 0.5deg,
                transparent 0.5deg 4.5deg,
                rgba(0, 255, 136, 0.8) 4.5deg 5deg
            );
            mask: radial-gradient(transparent 60%, black 61%); /* Bolongin tengahnya */
            -webkit-mask: radial-gradient(transparent 60%, black 61%);
        }
        /* Lapisan 2: Garis Kardinal Tebal (U, S, T, B) */
        .cardinal-marks {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-conic-gradient(from -0.5deg, #00ff88 0deg 1deg, transparent 1deg 89deg);
            mask: radial-gradient(transparent 55%, black 56%);
            -webkit-mask: radial-gradient(transparent 55%, black 56%);
            z-index: 2;
        }

        /* Huruf N Merah */
        .north-label {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            color: #ff0000; font-weight: 900; font-size: 1.5rem; z-index: 5;
            text-shadow: 0 0 10px #ff0000;
        }
        .other-labels {
             position: absolute; color: #00ff88; font-weight: bold; font-size: 1.2rem; z-index: 5;
        }

        /* Gambar Dial Lama (Ditaruh di belakang sebagai background samar) */
        .dial-bg {
            width: 100%; height: 100%; position: absolute; top:0; left:0;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Compass_Card.png/600px-Compass_Card.png') no-repeat center;
            background-size: 85%; opacity: 0.2; filter: invert(1) grayscale(1) brightness(0.6); z-index: 0;
        }

        /* Jarum Penunjuk Tetap (Diam di atas) */
        .static-needle {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); z-index: 10;
        }
        .static-needle::after {
            content: ''; display: block; border-top: 25px solid #ff3333;
            border-left: 12px solid transparent; border-right: 12px solid transparent;
            filter: drop-shadow(0 0 5px #ff3333);
        }

        /* --- HUD DATA --- */
        .hud-data { border-top: 2px solid #333; padding-top: 15px; width: 95%; margin: auto; background: rgba(0,20,10,0.5); }
        .big-deg { font-size: 3.5rem; font-weight: 900; color: #fff; text-shadow: 0 0 15px #00ff88; margin: 0; }
        .cardinal-text { font-size: 1.4rem; color: #00ff88; margin-bottom: 15px; font-weight: bold; letter-spacing: 2px; }
        
        .gps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.75rem; text-align: left; padding: 10px; background: #0a0a0a; border: 1px solid #222; }
        .gps-val { font-size: 0.9rem; color: #fff; font-weight: bold; }
        .back-btn { margin-top: 25px; display: inline-block; text-decoration: none; color: #888; font-size: 0.9rem; border: 1px solid #444; padding: 8px 20px; transition: 0.3s; }
        .back-btn:hover { border-color: #00ff88; color: #00ff88; }
    </style>
</head>
<body>

    <div id="pc-warning">⚠️ WARNING: Sensor Magnetometer tidak terdeteksi. Buka di HP.</div>

    <div style="margin-bottom: 20px; color: #888; font-size: 0.9rem;">
        <p>Sebelum klik, kalibrasi HP dengan gerakan angka 8.</p>
    </div>
    <button id="start-btn" onclick="initSystem()">AKTIFKAN SENSOR TAKTIS</button>

    <div class="compass-ui" id="ui-panel">
        <div class="compass-ring">
             <div class="static-needle"></div>

            <div id="rotating-container">
                <div class="north-label">N</div>
                <div class="other-labels" style="top: 50%; right: 10px; transform: translateY(-50%);">E</div>
                <div class="other-labels" style="bottom: 10px; left: 50%; transform: translateX(-50%);">S</div>
                <div class="other-labels" style="top: 50%; left: 10px; transform: translateY(-50%);">W</div>
                <div class="tick-marks"></div>
                <div class="cardinal-marks"></div>
                <div class="dial-bg"></div>
            </div>
        </div>

        <div class="hud-data">
            <div class="big-deg" id="degree-display">--°</div>
            <div class="cardinal-text" id="cardinal-display">KALIBRASI...</div>

            <div class="gps-grid">
                <div>LAT: <span id="lat-val" class="gps-val">mencari...</span></div>
                <div>LON: <span id="lon-val" class="gps-val">mencari...</span></div>
                <div>ALT: <span id="alt-val" class="gps-val">--</span></div>
                <div>ACC: <span id="acc-val" class="gps-val">--</span></div>
            </div>
        </div>
        
        <a href="index.html" class="back-btn"><< KEMBALI KE OS</a>
    </div>

    <script>
        if (!window.DeviceOrientationEvent && !window.AbsoluteOrientationSensor) {
            document.getElementById('pc-warning').style.display = 'block';
        }

        function initSystem() {
            // Khusus iOS 13+ butuh izin manual
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(res => {
                        if (res === 'granted') startSensors();
                        else alert("Izin sensor ditolak iOS.");
                    })
                    .catch(alert);
            } else {
                // Android / iOS lama langsung gas
                startSensors();
            }
        }

        function startSensors() {
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('ui-panel').style.display = 'block';
            startGPS();
            
            // --- CARA BARU (MODERN API - LEBIH AKURAT DI ANDROID) ---
            if ('AbsoluteOrientationSensor' in window) {
                try {
                    // Menggunakan sensor fusion (magnet + gyro + accelerometer)
                    const sensor = new AbsoluteOrientationSensor({ frequency: 60, referenceFrame: 'device' });
                    sensor.addEventListener('reading', () => {
                        // Konversi Quaternion ke Heading (Ribet matematikanya, tapi works)
                        const q = sensor.quaternion;
                        // Rumus magis konversi ke Yaw/Heading z-axis
                        let heading = Math.atan2(2*(q[0]*q[3] + q[1]*q[2]), 1 - 2*(q[2]*q[2] + q[3]*q[3])) * (180/Math.PI);
                        
                        // Normalisasi biar jadi 0-360 positif
                        if (heading < 0) heading += 360; 

                        // Kompensasi orientasi layar (kalau HP dimiringin landscape)
                        /* Note: Screen orientation API agak rewel di beberapa browser, 
                           kita pakai default portrait dulu 0 derajat kalau error */
                        let screenAdjustment = 0;
                        try { screenAdjustment = window.screen.orientation.angle; } catch(e){}
                        heading = (heading + screenAdjustment) % 360;

                        updateDisplay(heading, 'modern');
                    });
                    sensor.addEventListener('error', (error) => {
                        console.warn("Sensor Modern Gagal, beralih ke Legacy:", error);
                        startLegacyCompass(); // Fallback kalau HP jadul banget
                    });
                    sensor.start();
                    console.log("Mode Sensor: Modern AbsoluteOrientation");

                } catch (err) {
                    startLegacyCompass();
                }
            } 
            // --- CARA LAMA (FALLBACK & KHUSUS iOS) ---
            else {
                startLegacyCompass();
            }
        }

        function startLegacyCompass() {
            console.log("Mode Sensor: Legacy DeviceOrientation (iOS/Old Android)");
            window.addEventListener('deviceorientation', (e) => {
                let heading = null;
                if(e.webkitCompassHeading) {
                    // iOS: Ini biasanya paling akurat buat iPhone
                    heading = e.webkitCompassHeading;
                } else if (e.alpha !== null) {
                    // Android Lama: Sering ngaco offsetnya, tapi kita coba invers
                    heading = 360 - e.alpha; 
                }
                updateDisplay(heading, 'legacy');
            });
        }

        function updateDisplay(heading, mode) {
            if (heading === null || isNaN(heading)) return;
            
            // Putar container berlawanan arah jarum jam
            // Biar huruf 'N' selalu ngejar Utara Asli
            document.getElementById('rotating-container').style.transform = `rotate(${-heading}deg)`;

            let degreeNum = Math.round(heading);
            document.getElementById('degree-display').innerText = `${degreeNum}°`;
            document.getElementById('cardinal-display').innerText = getCardinal(degreeNum);
        }

        // --- FUNGSI PENDUKUNG LAINNYA TETAP SAMA ---
        function startGPS() {
             if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (pos) => {
                        document.getElementById('lat-val').innerText = pos.coords.latitude.toFixed(5);
                        document.getElementById('lon-val').innerText = pos.coords.longitude.toFixed(5);
                        document.getElementById('alt-val').innerText = pos.coords.altitude ? Math.round(pos.coords.altitude) + "m" : "N/A";
                        document.getElementById('acc-val').innerText = "±" + Math.round(pos.coords.accuracy) + "m";
                    },
                    (err) => console.warn("GPS Error"), 
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            } else { document.getElementById('lat-val').innerText = "No GPS Support"; }
        }

        function getCardinal(deg) {
            // Logic arah mata angin diperketat biar pas sama grafis baru
            if (deg >= 350 || deg < 10) return "UTARA (N)";
            if (deg >= 10 && deg < 80) return "TIMUR LAUT (NE)";
            if (deg >= 80 && deg < 100) return "TIMUR (E)";
            if (deg >= 100 && deg < 170) return "TENGGARA (SE)";
            if (deg >= 170 && deg < 190) return "SELATAN (S)";
            if (deg >= 190 && deg < 260) return "BARAT DAYA (SW)";
            if (deg >= 260 && deg < 280) return "BARAT (W)";
            if (deg >= 280 && deg < 350) return "BARAT LAUT (NW)";
            return "SINKRONISASI...";
        }
    </script>
</body>
</html>
