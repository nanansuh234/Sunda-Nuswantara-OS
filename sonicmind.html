<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonicMind v1.5 - Calibrated</title>
    <style>
        body {
            background-color: #000;
            color: #00ffcc;
            font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px;
        }

        h1 { text-shadow: 0 0 15px #00ffcc; margin-bottom: 5px; letter-spacing: 2px; text-transform: uppercase;}
        .container {
            width: 100%; max-width: 500px;
            background: #0a0a0a; border: 1px solid #005544;
            padding: 20px; border-radius: 15px; box-sizing: border-box;
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.1);
        }

        /* TAB SWITCH */
        .mode-switch { display: flex; margin-bottom: 20px; border: 1px solid #005544; border-radius: 8px; overflow: hidden; }
        .mode-btn { flex: 1; padding: 12px; border: none; background: #050505; color: #008877; font-weight: bold; cursor: pointer; }
        .mode-btn.active { background: #005544; color: #fff; }

        /* INPUTS */
        textarea {
            width: 100%; height: 80px; background: #001111; color: #00ffcc;
            border: 1px solid #005544; border-radius: 5px; padding: 10px;
            font-family: monospace; resize: none; box-sizing: border-box;
        }

        /* SLIDER SENSITIVITAS */
        .slider-container {
            margin-top: 20px; border: 1px dashed #333; padding: 10px; border-radius: 5px;
        }
        input[type=range] { width: 100%; accent-color: #00ffcc; }
        
        .level-meter {
            height: 5px; background: #333; margin-top: 5px; width: 0%; transition: 0.1s;
        }

        button.action {
            width: 100%; padding: 15px; border: none; border-radius: 5px;
            background: #00ffcc; color: #000; font-weight: 900;
            margin-top: 15px; cursor: pointer;
        }
        button.stop { background: #ff3333; color: white; display: none; }

        canvas { width: 100%; height: 80px; background: #000; border: 1px solid #333; margin-top: 20px; }
        #log { margin-top: 15px; background: #111; padding: 10px; border: 1px solid #333; min-height: 50px; font-size: 1.5rem; text-align: center; }
        
        .debug-info { font-size: 0.7rem; color: #666; margin-top: 5px; text-align: right;}
    </style>
</head>
<body>

    <h1>SONIC MIND v1.5</h1>

    <div class="container">
        <div class="mode-switch">
            <button class="mode-btn active" onclick="setMode('send')">KIRIM</button>
            <button class="mode-btn" onclick="setMode('receive')">TERIMA</button>
        </div>

        <div id="senderUI">
            <textarea id="msgInput" placeholder="Ketik pesan (A-Z, 0-9)..."></textarea>
            
            <div style="text-align:center; margin-top:10px;">
                Frekuensi: 
                <select id="freqMode" style="background:#000; color:#fff; border:1px solid #333; padding:5px;">
                    <option value="17500">üïµÔ∏è 17.5kHz (Safe Ultrasonic)</option>
                    <option value="19000">üëΩ 19kHz (High Stealth)</option>
                    <option value="800">üîä 800Hz (Test Bunyi)</option>
                </select>
            </div>

            <button class="action" id="btnSend" onclick="transmitMessage()">KIRIM SINYAL</button>
            <button class="action stop" id="btnStop" onclick="stopTransmit()">STOP</button>
        </div>

        <div id="receiverUI" style="display:none;">
            <button class="action" id="btnListen" onclick="startListening()">AKTIFKAN MIC & DECODE</button>
            
            <div class="slider-container">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                    <span>Sensitivitas (Threshold)</span>
                    <span id="threshVal">100</span>
                </div>
                <input type="range" id="thresholdSlider" min="10" max="200" value="100" oninput="updateThresh(this.value)">
                
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-top:5px;">
                    <span>Signal Input Level:</span>
                    <span id="inputLevel">0</span>
                </div>
                <div id="meterBar" class="level-meter" style="width:0%; background:#00ffcc;"></div>
            </div>

            <canvas id="visualizer"></canvas>
            <div style="font-size:0.8rem; color:#aaa; margin-top:10px;">PESAN MASUK:</div>
            <div id="log">...</div>
        </div>
    </div>

    <script>
        // CONFIG
        const DOT_DURATION = 120; // Agak diperlambat biar lebih akurat (120ms)
        const MORSE = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', '1': '.----', '2': '..---', '3': '...--',
            '4': '....-', '5': '.....', '6': '-....', '7': '--...', '8': '---..',
            '9': '----.', '0': '-----', ' ': '/'
        };
        const REVERSE_MORSE = Object.fromEntries(Object.entries(MORSE).map(([k, v]) => [v, k]));

        let audioCtx, oscillator, analyser, isListening = false, isTransmitting = false;
        let threshold = 100; // Default sensitivitas

        function updateThresh(val) {
            threshold = parseInt(val);
            document.getElementById('threshVal').innerText = val;
        }

        function setMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if(mode === 'send') {
                document.querySelector('.mode-btn:nth-child(1)').classList.add('active');
                document.getElementById('senderUI').style.display = 'block';
                document.getElementById('receiverUI').style.display = 'none';
                isListening = false;
            } else {
                document.querySelector('.mode-btn:nth-child(2)').classList.add('active');
                document.getElementById('senderUI').style.display = 'none';
                document.getElementById('receiverUI').style.display = 'block';
            }
        }

        // --- TRANSMITTER ---
        async function transmitMessage() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') await audioCtx.resume();
            
            const text = document.getElementById('msgInput').value.toUpperCase();
            const freq = parseInt(document.getElementById('freqMode').value);
            
            if(!text) return alert("Isi pesan dulu!");

            isTransmitting = true;
            document.getElementById('btnSend').style.display = 'none';
            document.getElementById('btnStop').style.display = 'inline-block';

            let morse = "";
            for(let c of text) if(MORSE[c]) morse += MORSE[c] + " ";

            for(let symbol of morse) {
                if(!isTransmitting) break;
                if(symbol === '.') await playTone(freq, DOT_DURATION);
                else if(symbol === '-') await playTone(freq, DOT_DURATION * 3);
                else if(symbol === ' ') await sleep(DOT_DURATION * 3);
                else if(symbol === '/') await sleep(DOT_DURATION * 7);
                await sleep(DOT_DURATION); // Gap antar simbol
            }
            stopTransmit();
        }

        function playTone(freq, dur) {
            return new Promise(r => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.value = freq;
                
                // Fade in/out to remove clicking noise
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 0.01);
                gain.gain.setValueAtTime(1, audioCtx.currentTime + (dur/1000) - 0.01);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + (dur/1000));

                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + (dur/1000));
                setTimeout(r, dur);
            });
        }
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        function stopTransmit() {
            isTransmitting = false;
            document.getElementById('btnSend').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
        }

        // --- RECEIVER ---
        async function startListening() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);
                
                isListening = true;
                document.getElementById('btnListen').style.display = 'none';
                draw();
                analyzeLoop();
            } catch(e) {
                alert("Mic Error: " + e);
            }
        }

        // VISUALIZER & LOGIC
        function draw() {
            if(!isListening) return;
            requestAnimationFrame(draw);
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            const bufferLength = analyser.frequencyBinCount;
            const data = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(data);
            
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);
            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;
            for(let i=0; i<bufferLength; i++) {
                const barHeight = data[i]/2;
                ctx.fillStyle = `rgb(0, ${barHeight+100}, 204)`;
                ctx.fillRect(x, canvas.height-barHeight, barWidth, barHeight);
                x += barWidth+1;
            }
        }

        let signalHistory = [];
        let currentMorse = "";
        let charTimer;

        function analyzeLoop() {
            if(!isListening) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const data = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(data);

            // Cari sinyal terkuat (Max Energy)
            let maxVal = 0;
            for(let i=0; i<bufferLength; i++) if(data[i] > maxVal) maxVal = data[i];

            // UPDATE UI DEBUG
            document.getElementById('inputLevel').innerText = maxVal;
            const percentage = (maxVal / 255) * 100;
            document.getElementById('meterBar').style.width = percentage + "%";
            
            // Logic Deteksi
            // Jika Input Level > Threshold Slider -> Sinyal ON
            const now = Date.now();
            const isSignal = maxVal > threshold;

            if(isSignal) {
                document.getElementById('meterBar').style.background = "#ff3333"; // Merah pas detect
                if(signalHistory.length === 0 || signalHistory[signalHistory.length-1].state === 0) {
                    signalHistory.push({state: 1, start: now});
                }
            } else {
                document.getElementById('meterBar').style.background = "#00ffcc";
                if(signalHistory.length > 0 && signalHistory[signalHistory.length-1].state === 1) {
                    // Sinyal mati, hitung durasi
                    let lastSig = signalHistory[signalHistory.length-1];
                    lastSig.state = 0;
                    let dur = now - lastSig.start;
                    
                    // Interpretasi
                    let sym = "";
                    if(dur > 50 && dur < 250) sym = "."; // Dot range
                    else if(dur >= 250 && dur < 800) sym = "-"; // Dash range
                    
                    if(sym) {
                        currentMorse += sym;
                        document.getElementById('log').innerText = "Signal: " + currentMorse;
                        clearTimeout(charTimer);
                        charTimer = setTimeout(finishChar, 1000); // 1 detik diem = huruf baru
                    }
                }
            }
            setTimeout(analyzeLoop, 20);
        }

        function finishChar() {
            if(REVERSE_MORSE[currentMorse]) {
                const txt = document.getElementById('log');
                if(txt.innerText.includes("Signal:")) txt.innerText = "";
                txt.innerText += REVERSE_MORSE[currentMorse];
            }
            currentMorse = "";
        }
    </script>
</body>
</html>
