<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesis File Manager v2.0 (Mobile Fix)</title>
    <style>
        /* TAMPILAN MODERN DARK MODE */
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --accent-color: #007acc;
            --text-color: #d4d4d4;
            --border-color: #3e3e42;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background-color: #333333;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        h1 { margin: 0; font-size: 1.1rem; color: #fff; }
        .btn-open {
            background: var(--accent-color);
            color: white; border: none; padding: 10px 15px;
            border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: 0.9rem;
        }
        .btn-open:hover { filter: brightness(1.1); }

        /* PATH BAR */
        .path-bar {
            background: var(--sidebar-color);
            padding: 8px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; gap: 10px; align-items: center;
            font-size: 0.9rem; color: #aaa;
        }
        .btn-back {
            background: transparent; border: 1px solid #555;
            color: #fff; cursor: pointer; border-radius: 3px;
            padding: 2px 8px; font-size: 1.2rem;
        }

        /* MAIN LAYOUT (Responsive buat HP) */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: row; /* Default PC: Kiri Kanan */
        }

        /* Di HP, Sidebar di atas, Preview di bawah (atau toggle) */
        @media (max-width: 600px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100% !important; height: 40% !important; border-bottom: 2px solid #007acc; }
            .preview-area { width: 100% !important; height: 60% !important; }
            h1 { font-size: 0.9rem; } 
        }

        /* SIDEBAR (FILE LIST) */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-color);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex; flex-direction: column;
        }

        .file-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid #2d2d2d;
            font-size: 0.9rem;
            user-select: none;
        }
        .file-item:hover { background-color: #2a2d2e; }
        .file-item.folder { color: #dcb67a; font-weight: bold; }
        .file-item.file { color: #9cdcfe; }

        /* PREVIEW AREA */
        .preview-area {
            flex: 1;
            background-color: #1e1e1e;
            padding: 20px;
            overflow-y: auto;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }

        /* PREVIEW ELEMENTS */
        img, video { max-width: 100%; max-height: 60vh; border: 1px solid #333; margin-top: 10px;}
        
        textarea {
            width: 95%; height: 60vh;
            background: #1e1e1e; color: #d4d4d4;
            border: 1px solid #333; padding: 15px;
            font-family: 'Consolas', monospace; font-size: 0.9rem;
            resize: none; outline: none; margin-top: 10px;
        }

        .empty-state { color: #555; font-size: 1.2rem; text-align: center; margin-top: 50px; }

        .editor-controls {
            width: 95%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;
        }
        .btn-save {
            background: #28a745; color: white; border: none;
            padding: 8px 15px; border-radius: 4px; cursor: pointer;
        }
        
        /* HIDDEN INPUT BUAT HP */
        #mobileInput { display: none; }
    </style>
</head>
<body>

    <header>
        <h1>üìÇ Genesis Manager</h1>
        <button class="btn-open" onclick="handleOpenButton()">üìÇ Buka File/Folder</button>
        <input type="file" id="mobileInput" multiple>
    </header>

    <div class="path-bar">
        <button class="btn-back" onclick="goBack()" title="Back">‚¨Ö</button>
        <span id="currentPath">/</span>
    </div>

    <div class="main-container">
        <div class="sidebar" id="fileList">
            <div style="padding:20px; text-align:center; color:#666;">
                Klik tombol di atas untuk mulai.
            </div>
        </div>

        <div class="preview-area" id="previewArea">
            <div class="empty-state">Preview Area</div>
        </div>
    </div>

    <script>
        // MODE DETECTOR
        const isDesktopAPI = !!window.showDirectoryPicker;
        
        let rootHandle;
        let currentHandle;
        let dirStack = []; 
        let currentFileHandle = null; 
        
        // Buat Mobile (Flat List)
        let mobileFiles = []; 

        const fileListEl = document.getElementById('fileList');
        const previewAreaEl = document.getElementById('previewArea');
        const pathEl = document.getElementById('currentPath');
        const mobileInput = document.getElementById('mobileInput');

        // --- 1. HANDLE TOMBOL BUKA ---
        async function handleOpenButton() {
            if (isDesktopAPI) {
                // VERSI PC (CANGGIH)
                try {
                    rootHandle = await window.showDirectoryPicker();
                    currentHandle = rootHandle;
                    dirStack = [];
                    await loadDirectoryPC(currentHandle);
                } catch (err) { console.log("Batal/Error PC:", err); }
            } else {
                // VERSI HP (FALLBACK)
                // Trigger klik input file biasa
                mobileInput.click();
            }
        }

        // --- 2. LOGIKA UNTUK HP (MOBILE INPUT) ---
        mobileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            mobileFiles = files;
            loadMobileFiles(mobileFiles);
        });

        function loadMobileFiles(files) {
            fileListEl.innerHTML = "";
            pathEl.innerText = "Mode HP (Selected Files)";
            
            // Di HP kita gak bisa struktur folder, jadi list file aja
            files.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'file-item file';
                div.innerHTML = `<span>üìÑ</span> <span>${file.name}</span>`;
                div.onclick = () => openFileMobile(file);
                fileListEl.appendChild(div);
            });
        }

        function openFileMobile(file) {
            const name = file.name.toLowerCase();
            previewAreaEl.innerHTML = `<div style="color:#aaa;">Loading ${file.name}...</div>`;

            const reader = new FileReader();

            // GAMBAR
            if (name.match(/\.(jpg|jpeg|png|gif|webp)$/)) {
                reader.onload = (e) => {
                    previewAreaEl.innerHTML = `<img src="${e.target.result}">`;
                };
                reader.readAsDataURL(file);
            }
            // VIDEO
            else if (name.match(/\.(mp4|webm|mkv)$/)) {
                const url = URL.createObjectURL(file);
                previewAreaEl.innerHTML = `<video controls src="${url}"></video>`;
            }
            // AUDIO
            else if (name.match(/\.(mp3|wav|ogg)$/)) {
                const url = URL.createObjectURL(file);
                previewAreaEl.innerHTML = `<audio controls src="${url}"></audio>`;
            }
            // TEKS (READ ONLY DI HP KARENA INPUT FILE GAK BISA SAVE BALIK)
            else if (name.match(/\.(txt|html|css|js|json|py|md|xml|log)$/)) {
                reader.onload = (e) => {
                    previewAreaEl.innerHTML = `
                        <div class="editor-controls">
                            <span style="color:#888;">${file.name} (Read Only di HP)</span>
                        </div>
                        <textarea readonly>${e.target.result}</textarea>
                    `;
                };
                reader.readAsText(file);
            }
            else {
                previewAreaEl.innerHTML = `<div class="empty-state">Format file tidak didukung preview.</div>`;
            }
        }


        // --- 3. LOGIKA UNTUK PC (DESKTOP API) ---
        async function loadDirectoryPC(dirHandle) {
            fileListEl.innerHTML = "";
            pathEl.innerText = dirHandle.name === rootHandle.name ? "/" : ".../" + dirHandle.name;
            
            const entries = [];
            for await (const entry of dirHandle.values()) {
                entries.push(entry);
            }

            entries.sort((a, b) => {
                if (a.kind === b.kind) return a.name.localeCompare(b.name);
                return a.kind === 'directory' ? -1 : 1;
            });

            for (const entry of entries) {
                const div = document.createElement('div');
                div.className = `file-item ${entry.kind === 'directory' ? 'folder' : 'file'}`;
                const icon = entry.kind === 'directory' ? 'üìÅ' : 'üìÑ';
                div.innerHTML = `<span>${icon}</span> <span>${entry.name}</span>`;
                
                div.onclick = () => {
                    if (entry.kind === 'directory') enterDirectoryPC(entry);
                    else openFilePC(entry);
                };
                fileListEl.appendChild(div);
            }
        }

        async function enterDirectoryPC(handle) {
            dirStack.push(currentHandle);
            currentHandle = handle;
            await loadDirectoryPC(handle);
        }

        async function goBack() {
            if (!isDesktopAPI) { alert("Mode HP tidak support Back Folder."); return; }
            if (dirStack.length > 0) {
                currentHandle = dirStack.pop();
                await loadDirectoryPC(currentHandle);
            }
        }

        async function openFilePC(fileHandle) {
            currentFileHandle = fileHandle;
            const file = await fileHandle.getFile();
            const name = file.name.toLowerCase();

            // (Logic sama kayak mobile tapi pake fileHandle buat fitur Save)
            // ... Simplified for brevity, use logic from previous code for types ...
             
            // Check Teks/Code untuk fitur Edit
            if (name.match(/\.(txt|html|css|js|json|py|md|xml|log)$/)) {
                const text = await file.text();
                previewAreaEl.innerHTML = `
                    <div class="editor-controls">
                        <span style="color:#aaa;">Editing: ${file.name}</span>
                        <button class="btn-save" onclick="saveCurrentFile()">üíæ SAVE</button>
                    </div>
                    <textarea id="editor" spellcheck="false">${text}</textarea>
                `;
                return;
            }

            // Fallback ke logic Mobile buat media (read only preview)
            openFileMobile(file); 
        }

        async function saveCurrentFile() {
            if (!currentFileHandle) return;
            const newContent = document.getElementById('editor').value;
            try {
                const writable = await currentFileHandle.createWritable();
                await writable.write(newContent);
                await writable.close();
                alert("‚úÖ File Tersimpan!");
            } catch (err) {
                alert("‚ùå Gagal simpan (Permission Error).");
            }
        }
    </script>
</body>
</html>