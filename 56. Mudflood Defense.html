<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citadel Guardian: Anti-Liquefaction System</title>
    <style>
        body {
            background: #1a1a1a; color: #ff3333; font-family: 'Consolas', monospace;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        h1 { margin: 0; text-transform: uppercase; letter-spacing: 3px; color: #fff; text-shadow: 0 0 10px #ff3333; }
        
        .viewport {
            position: relative; width: 800px; height: 500px;
            background: #000; border: 4px solid #555; border-radius: 5px;
            overflow: hidden; margin-top: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 1; }

        /* HUD & ALERTS */
        .hud {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #444;
            color: #ccc; font-size: 0.9rem;
        }
        .status-danger { color: #ff0040; font-weight: bold; animation: blink 0.5s infinite; }
        .status-safe { color: #00ff41; font-weight: bold; }
        
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

        /* CONTROLS */
        .control-panel {
            width: 800px; background: #222; border: 2px solid #555; border-top: none;
            padding: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;
        }

        .panel-group { border: 1px solid #444; padding: 10px; background: #151515; }
        .panel-title { font-size: 0.8rem; color: #888; margin-bottom: 10px; text-align: center; font-weight: bold; }
        
        button {
            width: 100%; padding: 10px; margin-top: 5px; cursor: pointer;
            border: 1px solid #444; background: #333; color: #fff; font-weight: bold;
        }
        button.active { background: #00ff41; color: #000; box-shadow: 0 0 10px #00ff41; }
        
        input[type=range] { width: 100%; accent-color: #ff3333; cursor: pointer; }

    </style>
</head>
<body>

    <h1>MUD FLOOD DEFENSE SYSTEM</h1>
    <div style="font-size:0.8rem; color:#888;">Resonance Detection & Soil Stabilization Unit</div>

    <div class="viewport">
        <div class="hud">
            <div>SOIL STATUS: <span id="soilStatus" class="status-safe">SOLID</span></div>
            <div>LIQUEFACTION INDEX: <span id="liqIndex">0%</span></div>
            <div>BUILDING INTEGRITY: <span id="buildHealth">100%</span></div>
        </div>
        <canvas id="simCanvas" width="800" height="500"></canvas>
    </div>

    <div class="control-panel">
        <div class="panel-group" style="border-color:#ff3333;">
            <div class="panel-title" style="color:#ff3333;">ENEMY ACTION (Resonance Attack)</div>
            <label>INTENSITY (Getaran)</label>
            <input type="range" id="attackSlider" min="0" max="100" value="0">
            <label>GROUND WATER (Air Tanah)</label>
            <input type="range" id="waterSlider" min="0" max="100" value="30">
        </div>

        <div class="panel-group">
            <div class="panel-title" style="color:#d4af37;">PASSIVE DEFENSE (Physical)</div>
            <button id="btnPaku" onclick="togglePaku()">ACTIVATE PAKU BUMI</button>
            <div style="font-size:0.7rem; color:#666; margin-top:5px;">*Mengunci pondasi ke Bedrock.</div>
        </div>

        <div class="panel-group">
            <div class="panel-title" style="color:#00ff41;">ACTIVE DEFENSE (Tech)</div>
            <button id="btnCancel" onclick="toggleCancel()">PHASE CANCELLATOR</button>
            <div style="font-size:0.7rem; color:#666; margin-top:5px;">*Menembak gelombang anti-fase.</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const w = 800;
        const h = 500;

        // ASSETS
        let groundY = 350; // Batas permukaan tanah
        let bedrockY = 480; // Batas batuan keras di bawah
        
        // Gedung Tartaria
        let buildings = [
            {x: 150, y: groundY, w: 100, h: 200, sunk: 0},
            {x: 350, y: groundY, w: 120, h: 250, sunk: 0}, // Gedung Utama
            {x: 600, y: groundY, w: 90, h: 180, sunk: 0}
        ];

        // Partikel Tanah
        let soilParticles = [];
        for(let i=0; i<400; i++) {
            soilParticles.push({
                x: Math.random() * w,
                y: Math.random() * (bedrockY - groundY) + groundY,
                vx: 0, vy: 0,
                orgY: 0
            });
            soilParticles[i].orgY = soilParticles[i].y;
        }

        // STATE
        let attackLvl = 0;
        let waterLvl = 30;
        let pakuActive = false;
        let cancelActive = false;
        let liquefaction = 0; // 0-100
        let time = 0;

        function togglePaku() {
            pakuActive = !pakuActive;
            document.getElementById('btnPaku').className = pakuActive ? 'active' : '';
        }

        function toggleCancel() {
            cancelActive = !cancelActive;
            document.getElementById('btnCancel').className = cancelActive ? 'active' : '';
        }

        function updatePhysics() {
            attackLvl = parseInt(document.getElementById('attackSlider').value);
            waterLvl = parseInt(document.getElementById('waterSlider').value);

            // HITUNG LIQUEFACTION (Rumus Kehancuran)
            // Getaran tinggi + Air banyak = Tanah Cair
            let rawDamage = (attackLvl * 1.5) + (waterLvl * 0.5);
            
            // Pengurang Damage (Defense)
            let resistance = 0;
            if (pakuActive) resistance += 40; // Paku bumi nahan fisik
            if (cancelActive) rawDamage -= (attackLvl * 0.9); // Cancellator mematikan getaran
            
            // Kalkulasi Akhir
            let currentStress = Math.max(0, rawDamage - resistance);
            
            // Liquefaction naik pelan-pelan kalau stress tinggi
            if (currentStress > 50) liquefaction += 0.5;
            else liquefaction -= 0.5;
            
            // Clamp 0-100
            if (liquefaction > 100) liquefaction = 100;
            if (liquefaction < 0) liquefaction = 0;

            // UPDATE HUD
            const statusEl = document.getElementById('soilStatus');
            document.getElementById('liqIndex').innerText = Math.floor(liquefaction) + "%";
            
            if (liquefaction > 80) {
                statusEl.innerText = "LIQUID (MUD FLOOD)";
                statusEl.className = "status-danger";
            } else if (liquefaction > 40) {
                statusEl.innerText = "JELLY (UNSTABLE)";
                statusEl.style.color = "yellow";
                statusEl.className = "";
            } else {
                statusEl.innerText = "SOLID";
                statusEl.className = "status-safe";
            }
        }

        function drawScene() {
            // Langit
            ctx.fillStyle = "#050510"; ctx.fillRect(0, 0, w, h);

            // 1. BEDROCK (Lapisan Keras - Paling Bawah)
            ctx.fillStyle = "#222"; 
            ctx.fillRect(0, bedrockY, w, h - bedrockY);
            
            // 2. SOIL PARTICLES (Tanah yang bisa cair)
            // Warna tanah berubah: Coklat (Keras) -> Abu (Cair)
            let soilColor = `rgb(${100 - liquefaction}, ${80 - liquefaction/2}, 50)`;
            ctx.fillStyle = soilColor;
            
            soilParticles.forEach(p => {
                // Getaran partikel
                let shake = (liquefaction / 100) * 5;
                let fluid = (liquefaction / 100) * 2;
                
                // Kalau cair, partikel mulai ngalir random
                p.x += (Math.random()-0.5) * shake;
                p.y += (Math.random()-0.5) * shake;

                // Physics Tanah Cair: Partikel cenderung turun merata
                if (liquefaction > 80) {
                    // Tanah jadi lumpur rata
                } else {
                    // Tanah berusaha balik ke posisi asal (Solid)
                    p.y += (p.orgY - p.y) * 0.1; 
                }

                ctx.fillRect(p.x, p.y, 4, 4);
            });

            // 3. PAKU BUMI (Defense)
            if (pakuActive) {
                ctx.strokeStyle = "#888";
                ctx.lineWidth = 6;
                // Gambar paku di bawah setiap gedung
                buildings.forEach(b => {
                    let centerX = b.x + b.w/2;
                    // Paku tembus dari pondasi gedung sampai Bedrock
                    ctx.beginPath();
                    ctx.moveTo(centerX, b.y + b.sunk);
                    ctx.lineTo(centerX, bedrockY + 20); // Nancap ke bedrock
                    ctx.stroke();
                    
                    // Detail Grip
                    ctx.fillStyle = "#fff";
                    ctx.fillRect(centerX-5, bedrockY, 10, 10); // Anchor point
                });
            }

            // 4. GEDUNG TARTARIA
            buildings.forEach(b => {
                // Logic Sinking (Gedung Amblas)
                if (liquefaction > 50) {
                    // Kalau tanah cair, gedung turun pelan-pelan
                    // Kalau ada paku bumi, sinking ditahan total
                    if (!pakuActive) {
                        b.sunk += 0.5;
                    }
                }
                
                // Gambar Gedung
                ctx.fillStyle = "#d4af37"; // Emas kusam
                let currentY = b.y + b.sunk;
                
                // Badan Gedung
                ctx.fillRect(b.x, currentY - b.h, b.w, b.h);
                
                // Jendela (Indikator kedalaman)
                ctx.fillStyle = "#000";
                for(let j=1; j<5; j++) {
                    ctx.fillRect(b.x + 10, currentY - (j*40), 20, 20);
                    ctx.fillRect(b.x + b.w - 30, currentY - (j*40), 20, 20);
                }

                // Kubah
                ctx.beginPath();
                ctx.arc(b.x + b.w/2, currentY - b.h, b.w/2, Math.PI, 0);
                ctx.fillStyle = "#a300cc"; // Ungu
                ctx.fill();
                
                // Kalau tenggelam banget, gedung miring/hancur
                if (b.sunk > 100) {
                    document.getElementById('buildHealth').innerText = "CRITICAL (SINKING)";
                    document.getElementById('buildHealth').style.color = "red";
                }
            });

            // 5. VISUALISASI GELOMBANG (Attack vs Defense)
            // Gelombang Serangan (Merah dari bawah)
            if (attackLvl > 0) {
                ctx.strokeStyle = "rgba(255, 0, 0, 0.3)";
                ctx.lineWidth = 2;
                ctx.beginPath();
                for(let x=0; x<w; x+=10) {
                    let y = bedrockY - 20 + Math.sin(x*0.05 + time) * (attackLvl/2);
                    if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                }
                ctx.stroke();
            }

            // Gelombang Cancellator (Hijau berlawanan)
            if (cancelActive && attackLvl > 0) {
                ctx.strokeStyle = "rgba(0, 255, 65, 0.5)";
                ctx.lineWidth = 2;
                ctx.beginPath();
                for(let x=0; x<w; x+=10) {
                    // Phase shift 180 derajat (Minus sin)
                    let y = bedrockY - 20 - Math.sin(x*0.05 + time) * (attackLvl/2); 
                    if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                }
                ctx.stroke();
                
                // Efek Flatlining (Gelombang mati)
                ctx.strokeStyle = "#fff"; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(0, bedrockY-20); ctx.lineTo(w, bedrockY-20); ctx.stroke();
            }
        }

        function animate() {
            ctx.clearRect(0, 0, w, h);
            time += 0.2;
            
            updatePhysics();
            drawScene();
            
            requestAnimationFrame(animate);
        }

        animate();

    </script>
</body>
</html>