<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Tracker Final - Nuswantara</title>
    <style>
        /* --- RESET & BASIC --- */
        body {
            background-color: #000;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            margin: 0;
            overflow: hidden; /* Wajib biar gak bisa scroll halaman */
            touch-action: none; /* Matikan zoom default browser */
        }

        /* --- HUD ATAS (INFO JARAK) --- */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0, 20, 0, 0.9);
            padding: 15px;
            display: grid; grid-template-columns: 1fr 1fr;
            border-bottom: 2px solid #00ff88;
            z-index: 20;
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        .hud-val { font-size: 1.4rem; font-weight: bold; color: #fff; text-shadow: 0 0 5px #00ff88; }
        .hud-label { font-size: 0.75rem; color: #aaa; letter-spacing: 1px; }

        /* --- HUD BAWAH (TOMBOL MENU) --- */
        /* FIX: Diangkat 120px biar gak kena Taskbar OS */
        .hud-bottom {
            position: absolute; 
            bottom: 120px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%; 
            max-width: 500px;
            
            background: rgba(0, 30, 10, 0.95);
            border: 1px solid #00ff88;
            border-radius: 50px; /* Bentuk Kapsul */
            
            padding: 12px;
            display: flex; gap: 10px; overflow-x: auto;
            z-index: 9999; /* Lapisan paling atas */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            
            /* Sembunyikan Scrollbar tapi tetap bisa discroll */
            scrollbar-width: none; 
        }
        .hud-bottom::-webkit-scrollbar { display: none; }

        /* --- BUTTON STYLES --- */
        button {
            background: #002211; color: #00ff88; border: 1px solid #00ff88;
            padding: 12px 20px; font-weight: bold; white-space: nowrap;
            font-family: inherit; font-size: 0.85rem; border-radius: 30px;
            cursor: pointer; transition: 0.2s;
        }
        button:active { background: #00ff88; color: #000; transform: scale(0.95); }

        /* Tombol Spesial */
        #btn-rec { background: #330000; border-color: #ff3333; color: #ff3333; min-width: 80px; }
        #btn-rec.recording { background: #ff0000; color: white; animation: pulse 1.5s infinite; }
        
        #btn-cam { background: #004455; color: #00ccff; border-color: #00ccff; }
        #btn-cam.locked { background: #00ccff; color: #000; box-shadow: 0 0 10px #00ccff; }

        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        /* --- LAYAR PETA (CANVAS) --- */
        #canvas-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505;
            /* Grid Pattern Background */
            background-image: radial-gradient(#112211 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* --- NOTIFIKASI TENGAH --- */
        #status-msg {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px; 
            border: 2px solid #ff3333; border-radius: 10px;
            text-align: center; display: none; z-index: 30;
            color: #fff; width: 80%;
        }
        #status-msg button { margin-top: 10px; width: 100%; background: #fff; color: #000; }

    </style>
</head>
<body>

    <div class="hud-top">
        <div>
            <div class="hud-label">JARAK TEMPUH</div>
            <span id="dist-display" class="hud-val">0</span> <span style="font-size:0.8rem">m</span>
        </div>
        <div style="text-align: right;">
            <div class="hud-label">ESTIMASI LANGKAH</div>
            <span id="step-display" class="hud-val">0</span>
        </div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="mapCanvas"></canvas>
    </div>

    <div id="status-msg">
        MENCARI SATELIT...<br>
        <small style="color:#aaa;">Pastikan Anda di luar ruangan.<br>Proses ini butuh waktu 10-60 detik.</small>
    </div>

    <div class="hud-bottom">
        <button id="btn-rec" onclick="toggleRecord()">REC</button>
        <button id="btn-cam" class="locked" onclick="toggleCamera()">üîí KUNCI</button>
        <button onclick="addMarker('üè†','Markas')">üè†</button>
        <button onclick="addMarker('üíß','Air')">üíß</button>
        <button onclick="addMarker('üíÄ','Bahaya')">üíÄ</button>
        <button onclick="addMarker('üö©','Target')">üö©</button>
        <button onclick="saveImage()" style="margin-left:auto; background:#00ff88; color:black;">üíæ SIMPAN</button>
    </div>

    <script>
        // --- KONFIGURASI ---
        const METER_TO_PIXEL = 4; // Zoom level (Makin besar makin zoom in)
        const MIN_MOVE = 3;       // Filter: Gerak minimal 3 meter baru gambar (Anti keriting)
        const STEP_LENGTH = 0.75; // Panjang langkah rata-rata (meter)

        // --- VARIABLE STATE ---
        let isRecording = false;
        let isCameraLocked = true; // Default: Kamera ngikutin player
        let watchId = null;
        
        let path = [];    // Jalur {x, y}
        let markers = []; // Icon {x, y, icon, label}
        
        // Koordinat Geografis & Pixel
        let startGeo = null; 
        let lastGeo = null;
        let playerX = 0;
        let playerY = 0;
        
        // Kamera Virtual (Offset)
        let camX = 0;
        let camY = 0;
        
        let totalDistance = 0;

        // --- SETUP CANVAS ---
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            redraw();
        }
        window.addEventListener('resize', resize);
        resize();

        // --- CORE: GPS TRACKER ---
        function toggleRecord() {
            const btn = document.getElementById('btn-rec');
            if (!isRecording) {
                // START RECORDING
                if (!navigator.geolocation) return alert("HP tidak support GPS");
                
                isRecording = true;
                btn.classList.add('recording');
                btn.innerText = "STOP";
                
                // Tampilkan Loading
                const msg = document.getElementById('status-msg');
                msg.innerHTML = "üì° MENCARI SINYAL SATELIT...<br><small style='color:#ccc'>Mohon tunggu di tempat terbuka...</small>";
                msg.style.display = 'block';
                msg.style.borderColor = "#00ff88"; // Warna ijo loading
                
                // Kunci kamera ke player
                isCameraLocked = true;
                updateCamBtn();

                // --- SETTING GPS SENSITIF (ANTI-TIMEOUT) ---
                const gpsOptions = { 
                    enableHighAccuracy: true, // Wajib ON buat mapping
                    maximumAge: 0,            // Jangan pake cache lama
                    timeout: 60000            // 60 Detik Toleransi (PENTING)
                };

                watchId = navigator.geolocation.watchPosition(
                    updatePosition, 
                    handleError, 
                    gpsOptions
                );
            } else {
                // STOP RECORDING
                isRecording = false;
                btn.classList.remove('recording');
                btn.innerText = "REC";
                navigator.geolocation.clearWatch(watchId);
                document.getElementById('status-msg').style.display = 'none';
                
                // Lepas kunci kamera biar user bisa geser-geser liat hasil
                isCameraLocked = false;
                updateCamBtn();
                alert("Tracking Selesai. Geser layar untuk melihat peta.");
            }
        }

        // --- SUKSES DAPAT SINYAL ---
        function updatePosition(pos) {
            document.getElementById('status-msg').style.display = 'none'; // Sembunyikan loading
            
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            
            // Inisialisasi Titik Awal (Titik 0,0)
            if (!startGeo) {
                startGeo = { lat, lon };
                lastGeo = { lat, lon };
                path.push({x: 0, y: 0});
                return;
            }

            // Hitung Jarak dari titik terakhir
            const dist = getDist(lastGeo.lat, lastGeo.lon, lat, lon);

            // Filter Noise (Cuma update kalau gerak > MIN_MOVE)
            if (dist >= MIN_MOVE) {
                totalDistance += dist;
                updateStats();

                // Matematika Konversi LatLon ke Pixel X,Y (Flat Earth Approximation)
                // 1. Hitung selisih derajat
                const dLat = lat - startGeo.lat;
                const dLon = lon - startGeo.lon;
                
                // 2. Konversi ke Meter (1 Derajat Lat ~= 111.32 km)
                const metersY = dLat * 111320; 
                // Koreksi Longitude berdasarkan Latitude (makin ke kutub makin pendek)
                const metersX = dLon * 111320 * Math.cos(startGeo.lat * (Math.PI/180));

                // 3. Konversi ke Pixel & Update Posisi Player
                playerX = metersX * METER_TO_PIXEL;
                playerY = -metersY * METER_TO_PIXEL; // Sumbu Y browser kebalik (atas negatif)

                // 4. Simpan ke Path
                path.push({x: playerX, y: playerY});
                lastGeo = { lat, lon };
                
                redraw();
            }
        }

        // --- ERROR HANDLING GPS ---
        function handleError(err) {
            console.warn('GPS Error: ' + err.message);
            const msgBox = document.getElementById('status-msg');
            msgBox.style.display = 'block';
            msgBox.style.borderColor = "#ff3333";
            
            let pesan = "GPS ERROR";
            let saran = "Coba restart browser.";

            if (err.code === 1) { 
                pesan = "IZIN DITOLAK"; 
                saran = "Izinkan akses lokasi di pengaturan browser.";
            } else if (err.code === 2) { 
                pesan = "SINYAL HILANG"; 
                saran = "Pastikan Anda berada di LUAR RUANGAN (Outdoor).";
            } else if (err.code === 3) { 
                pesan = "TIMEOUT (WAKTU HABIS)"; 
                saran = "Sinyal satelit lemah. Pindah ke tempat lebih terbuka.";
            }

            msgBox.innerHTML = `‚ö†Ô∏è ${pesan}<br><small>${saran}</small><br><button onclick='location.reload()'>COBA LAGI</button>`;
        }

        // --- FITUR KAMERA & VISUAL ---
        function toggleCamera() {
            isCameraLocked = !isCameraLocked;
            updateCamBtn();
            redraw();
        }
        
        function updateCamBtn() {
            const btn = document.getElementById('btn-cam');
            if (isCameraLocked) {
                btn.classList.add('locked');
                btn.innerText = "üîí KUNCI";
            } else {
                btn.classList.remove('locked');
                btn.innerText = "‚úã GESER";
            }
        }

        // --- LOGIC MENGGAMBAR (RENDER) ---
        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Tentukan Posisi Kamera
            if (isCameraLocked) {
                camX = playerX;
                camY = playerY;
            }
            
            // Hitung Offset Rendering (Supaya Kamera ada di tengah layar)
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const offsetX = centerX - camX;
            const offsetY = centerY - camY;

            // 1. Gambar Grid Background (Efek bergerak)
            drawGrid(offsetX, offsetY);

            // 2. Gambar Jalur (Path)
            if (path.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Gambar titik pertama
                ctx.moveTo(path[0].x + offsetX, path[0].y + offsetY);
                
                // Sambung titik selanjutnya
                for (let i = 1; i < path.length; i++) {
                    ctx.lineTo(path[i].x + offsetX, path[i].y + offsetY);
                }
                ctx.stroke();
                
                // Efek Glow Jalur
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#00ff88';
                ctx.stroke();
                ctx.shadowBlur = 0; // Reset glow
            }

            // 3. Gambar Markers (Rumah, Air, dll)
            ctx.font = "24px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            markers.forEach(m => {
                const mx = m.x + offsetX;
                const my = m.y + offsetY;
                ctx.fillText(m.icon, mx, my);
                
                // Label kecil
                ctx.fillStyle = "#fff";
                ctx.font = "10px sans-serif";
                ctx.fillText(m.label, mx, my + 18);
            });

            // 4. Gambar Player (Segitiga Putih)
            const px = playerX + offsetX;
            const py = playerY + offsetY;
            
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.arc(px, py, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Lingkaran Radar Player
            ctx.strokeStyle = "rgba(255,255,255,0.5)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(px, py, 15, 0, Math.PI * 2);
            ctx.stroke();

            // 5. Gambar Legend (Pojok Kiri Bawah, diatas tombol)
            drawLegend();
        }

        function drawGrid(ox, oy) {
            // Logic grid sederhana
            const gridSize = 50;
            const startX = ox % gridSize;
            const startY = oy % gridSize;
            
            ctx.fillStyle = "#111"; // Warna titik grid
            
            // Gambar kotak-kotak atau titik
            for (let x = startX; x < canvas.width; x += gridSize) {
                for (let y = startY; y < canvas.height; y += gridSize) {
                    ctx.fillRect(x, y, 2, 2); // Titik kecil
                }
            }
        }

        function drawLegend() {
            const pad = 10;
            const boxW = 160;
            const boxH = 90;
            // Posisi Legend: Kiri Bawah, tapi agak atas biar gak ketutupan tombol
            const startY = canvas.height - 250; 
            
            ctx.fillStyle = "rgba(0, 20, 0, 0.8)";
            ctx.strokeStyle = "#00ff88";
            ctx.lineWidth = 2;
            
            ctx.fillRect(pad, startY, boxW, boxH);
            ctx.strokeRect(pad, startY, boxW, boxH);
            
            ctx.fillStyle = "#fff";
            ctx.font = "bold 12px Courier New";
            ctx.textAlign = "left";
            ctx.fillText("LEGENDA PETA:", pad + 10, startY + 20);
            
            ctx.font = "11px Courier New";
            ctx.fillStyle = "#aaa";
            ctx.fillText("‚îÅ‚îÅ‚îÅ  Jalur Gerak", pad + 10, startY + 40);
            ctx.fillText("üè†   Posisi Markas", pad + 10, startY + 55);
            ctx.fillText("üíÄ   Area Bahaya", pad + 10, startY + 70);
        }

        // --- TOUCH CONTROLS (GESER PETA) ---
        let isDragging = false;
        let startDragX, startDragY;
        let startCamX, startCamY;

        canvas.addEventListener('touchstart', e => {
            if (isCameraLocked) return; // Gak bisa geser kalau dikunci
            isDragging = true;
            startDragX = e.touches[0].clientX;
            startDragY = e.touches[0].clientY;
            startCamX = camX;
            startCamY = camY;
        });

        canvas.addEventListener('touchmove', e => {
            if (!isDragging) return;
            e.preventDefault(); // Cegah pull-to-refresh browser
            const dx = e.touches[0].clientX - startDragX;
            const dy = e.touches[0].clientY - startDragY;
            
            // Update posisi kamera (Inverse Drag)
            camX = startCamX - dx;
            camY = startCamY - dy;
            redraw();
        });

        canvas.addEventListener('touchend', () => { isDragging = false; });

        // --- UTILITIES ---
        function addMarker(icon, label) {
            // Bisa nambah marker kalau lagi rekam ATAU sudah ada jalur
            if (!isRecording && path.length === 0) return alert("Rekam jalur dulu!");
            
            markers.push({ x: playerX, y: playerY, icon: icon, label: label });
            redraw();
        }

        function updateStats() {
            document.getElementById('dist-display').innerText = Math.round(totalDistance);
            document.getElementById('step-display').innerText = Math.floor(totalDistance / STEP_LENGTH);
        }

        function saveImage() {
            redraw(); // Refresh biar legend bersih
            const link = document.createElement('a');
            const time = new Date().toLocaleTimeString().replace(/:/g, "-");
            link.download = `Peta_Nuswantara_${time}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // Rumus Haversine (Hitung Jarak GPS)
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2 - lat1) * Math.PI/180;
            const dLon = (lon2 - lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
