<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Tracker v2 - Nuswantara</title>
    <style>
        body {
            background-color: #000;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            margin: 0;
            overflow: hidden; /* Wajib biar gak bounce pas geser peta */
            touch-action: none; /* Matikan zoom browser bawaan */
        }

        /* HUD ATAS (INFO) */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0, 20, 0, 0.85);
            padding: 10px;
            display: grid; grid-template-columns: 1fr 1fr;
            border-bottom: 2px solid #00ff88;
            z-index: 20;
            box-sizing: border-box;
        }
        .hud-val { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .hud-label { font-size: 0.7rem; color: #aaa; }

/* HUD BAWAH (DANGAK KE ATAS BIAR GAK KETABRAK TASKBAR JAM) */
        .hud-bottom {
            position: absolute; 
            bottom: 110px; /* INI KUNCINYA: Angkat tinggi biar di atas jam */
            left: 50%;
            transform: translateX(-50%);
            width: 90%; 
            
            background: rgba(0, 30, 10, 0.95); /* Gelapin dikit biar kontras */
            border: 1px solid #00ff88;
            border-radius: 50px; /* Lebih bulet biar kayak kapsul canggih */
            
            padding: 10px;
            display: flex; gap: 10px; overflow-x: auto;
            z-index: 9999; /* Pastikan dia paling depan */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
        }

        /* Styling scrollbar biar rapi */
        .hud-bottom::-webkit-scrollbar { height: 0px; background: transparent; }
            
            /* Support buat iPhone poni/island biar gak kena garis home */
            padding-bottom: env(safe-area-inset-bottom); 
            
            display: flex; gap: 8px; overflow-x: auto; /* Scroll samping kalau tombol kebanyakan */
            z-index: 50; /* Z-index tinggi biar di atas segalanya */
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        /* Biar scrollbar di menu bawah gak nongol (estetika) */
        .hud-bottom::-webkit-scrollbar {
            display: none;
        }
        
        /* Tombol Record Spesial */
        #btn-rec { background: #330000; border-color: #ff3333; color: #ff3333; min-width: 80px; }
        #btn-rec.recording { background: #ff0000; color: white; animation: blink 1s infinite; }
        
        /* Tombol Camera Lock */
        #btn-cam { background: #004455; color: #00ccff; border-color: #00ccff; }
        #btn-cam.locked { background: #00ccff; color: #000; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* LAYAR UTAMA */
        #canvas-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505;
            /* Grid Pattern Background */
            background-image: radial-gradient(#112211 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Notifikasi */
        #status-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); padding: 20px; border: 1px solid #555;
            text-align: center; display: none; z-index: 30;
        }
    </style>
</head>
<body>

    <div class="hud-top">
        <div>
            <div class="hud-label">JARAK TEMPUH</div>
            <span id="dist-display" class="hud-val">0</span> <span style="font-size:0.8rem">Meter</span>
        </div>
        <div style="text-align: right;">
            <div class="hud-label">ESTIMASI LANGKAH</div>
            <span id="step-display" class="hud-val">0</span> <span style="font-size:0.8rem">Langkah</span>
        </div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="mapCanvas"></canvas>
    </div>

    <div id="status-msg">GPS SEARCHING...<br><small>Pastikan di luar ruangan</small></div>

    <div class="hud-bottom">
        <button id="btn-rec" onclick="toggleRecord()">REC</button>
        <button id="btn-cam" class="locked" onclick="toggleCamera()">üîí KUNCI</button>
        <button onclick="addMarker('üè†','Markas')">üè†</button>
        <button onclick="addMarker('üíß','Air')">üíß</button>
        <button onclick="addMarker('üíÄ','Bahaya')">üíÄ</button>
        <button onclick="addMarker('üö©','Target')">üö©</button>
        <button onclick="saveImage()" style="margin-left:auto; background:#00ff88; color:black;">üíæ SIMPAN</button>
    </div>

    <script>
        // --- KONFIGURASI ---
        const METER_TO_PIXEL = 4; // Zoom level (1 meter = 4 pixel)
        const MIN_MOVE = 3; // Filter: Gerak minimal 3 meter baru digambar (anti-keriting)
        const STEP_LENGTH = 0.75; // Panjang langkah rata-rata (0.75 meter)

        // --- STATE VARIABLES ---
        let isRecording = false;
        let isCameraLocked = true; // True = Kamera ngikutin player
        let watchId = null;
        
        let path = []; // Array koordinat {x, y}
        let markers = []; // Array icon {x, y, icon, label}
        
        // Posisi Global
        let startGeo = null; // LatLon awal
        let lastGeo = null;
        let playerX = 0;
        let playerY = 0;
        
        // Camera Offset (Buat geser-geser peta)
        let camX = 0;
        let camY = 0;
        
        let totalDistance = 0;

        // --- SETUP CANVAS ---
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            redraw();
        }
        window.addEventListener('resize', resize);
        resize();

        // --- GPS LOGIC ---
        function toggleRecord() {
            const btn = document.getElementById('btn-rec');
            if (!isRecording) {
                // START
                if (!navigator.geolocation) return alert("HP tidak support GPS");
                isRecording = true;
                btn.classList.add('recording');
                btn.innerText = "STOP";
                document.getElementById('status-msg').style.display = 'block';
                
                // Lock camera pas mulai record
                isCameraLocked = true;
                updateCamBtn();

                watchId = navigator.geolocation.watchPosition(
                    updatePosition, 
                    err => alert("GPS Error: " + err.message),
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
                );
            } else {
                // STOP
                isRecording = false;
                btn.classList.remove('recording');
                btn.innerText = "REC";
                navigator.geolocation.clearWatch(watchId);
                document.getElementById('status-msg').style.display = 'none';
                
                // Otomatis buka kunci kamera biar user bisa geser-geser liat hasil
                isCameraLocked = false;
                updateCamBtn();
                alert("Tracking Selesai. Silakan geser layar untuk melihat peta jalur.");
            }
        }

        function updatePosition(pos) {
            document.getElementById('status-msg').style.display = 'none'; // Sembunyikan loading
            
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const acc = pos.coords.accuracy;

            // Inisialisasi Titik Awal
            if (!startGeo) {
                startGeo = { lat, lon };
                lastGeo = { lat, lon };
                path.push({x: 0, y: 0});
                return;
            }

            // Hitung Jarak dari titik terakhir
            const dist = getDist(lastGeo.lat, lastGeo.lon, lat, lon);

            // Filter Noise (Cuma update kalau gerak > MIN_MOVE)
            if (dist >= MIN_MOVE) {
                totalDistance += dist;
                updateStats();

                // Konversi LatLon ke X,Y Pixel (Relatif ke Start)
                // Kita anggap Bumi datar lokal (Flat Earth approximation for small area) is enough
                const dLat = lat - startGeo.lat;
                const dLon = lon - startGeo.lon;
                
                // 1 Derajat Lat ~= 111,320 meter
                // 1 Derajat Lon ~= 111,320 meter * cos(lat)
                const metersY = dLat * 111320; 
                const metersX = dLon * 111320 * Math.cos(startGeo.lat * (Math.PI/180));

                playerX = metersX * METER_TO_PIXEL;
                playerY = -metersY * METER_TO_PIXEL; // Y browser kebalik (atas negatif)

                path.push({x: playerX, y: playerY});
                lastGeo = { lat, lon };
                
                redraw();
            }
        }

        // --- VISUAL & CAMERA ---
        function toggleCamera() {
            isCameraLocked = !isCameraLocked;
            updateCamBtn();
            redraw();
        }
        
        function updateCamBtn() {
            const btn = document.getElementById('btn-cam');
            if (isCameraLocked) {
                btn.classList.add('locked');
                btn.innerText = "üîí KUNCI";
            } else {
                btn.classList.remove('locked');
                btn.innerText = "‚úã GESER";
            }
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Hitung posisi Kamera
            let renderOffsetX, renderOffsetY;
            
            if (isCameraLocked) {
                // Kamera fokus ke Player (Tengah Layar)
                camX = playerX;
                camY = playerY;
            }
            
            // Posisi tengah layar
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Semua objek digambar relatif terhadap camX, camY
            renderOffsetX = centerX - camX;
            renderOffsetY = centerY - camY;

            // 1. Gambar Grid (Biar kelihatan gerak)
            drawGridBackground(renderOffsetX, renderOffsetY);

            // 2. Gambar Jalur
            if (path.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.moveTo(path[0].x + renderOffsetX, path[0].y + renderOffsetY);
                for (let i = 1; i < path.length; i++) {
                    ctx.lineTo(path[i].x + renderOffsetX, path[i].y + renderOffsetY);
                }
                ctx.stroke();
            }

            // 3. Gambar Marker
            ctx.font = "24px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            markers.forEach(m => {
                ctx.fillText(m.icon, m.x + renderOffsetX, m.y + renderOffsetY);
                // Label kecil di bawah icon
                ctx.fillStyle = "#aaa";
                ctx.font = "10px sans-serif";
                ctx.fillText(m.label, m.x + renderOffsetX, m.y + renderOffsetY + 15);
                ctx.fillStyle = "#000"; // Reset
            });

            // 4. Gambar Player (Segitiga)
            // Player selalu ada di koordinat aslinya + offset kamera
            const px = playerX + renderOffsetX;
            const py = playerY + renderOffsetY;
            
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.arc(px, py, 6, 0, Math.PI * 2);
            ctx.fill();
            // Efek Pulse
            ctx.strokeStyle = "rgba(255,255,255,0.5)";
            ctx.beginPath();
            ctx.arc(px, py, 12, 0, Math.PI * 2);
            ctx.stroke();

            // 5. Gambar Legend (Pojok Kiri Atas Canvas)
            drawLegend();
        }

        function drawGridBackground(ox, oy) {
            // Grid sederhana biar gak pusing liat layar hitam
            // Logic: Grid statis yang geser sesuai offset, dimodulo biar looping
            const gridSize = 50;
            const offsetX = ox % gridSize;
            const offsetY = oy % gridSize;
            
            ctx.fillStyle = "#111";
            for (let x = offsetX; x < canvas.width; x += gridSize) {
                ctx.fillRect(x, 0, 1, canvas.height);
            }
            for (let y = offsetY; y < canvas.height; y += gridSize) {
                ctx.fillRect(0, y, canvas.width, 1);
            }
        }
        
        function drawLegend() {
            // Kotak background legend
            const boxW = 160;
            const boxH = 90;
            const pad = 10;
            const startY = canvas.height - 180; // Di atas tombol
            
            // Gambar di canvas biar ikut ke-save
            ctx.fillStyle = "rgba(0, 20, 0, 0.7)";
            ctx.strokeStyle = "#00ff88";
            ctx.lineWidth = 1;
            ctx.fillRect(pad, startY, boxW, boxH);
            ctx.strokeRect(pad, startY, boxW, boxH);
            
            // Isi Teks Legend
            ctx.fillStyle = "#fff";
            ctx.font = "bold 12px Courier New";
            ctx.textAlign = "left";
            ctx.fillText("LEGENDA PETA:", pad + 10, startY + 20);
            
            ctx.font = "11px Courier New";
            ctx.fillStyle = "#aaa";
            ctx.fillText("‚îÅ‚îÅ‚îÅ  Jalur Gerak", pad + 10, startY + 40);
            ctx.fillText("üè†   Posisi Markas", pad + 10, startY + 55);
            ctx.fillText("üíÄ   Area Bahaya", pad + 10, startY + 70);
        }

        // --- INTERAKSI TOUCH (GESER PETA) ---
        let isDragging = false;
        let startDragX, startDragY;
        let startCamX, startCamY;

        canvas.addEventListener('touchstart', e => {
            if (isCameraLocked) return; // Gak bisa geser kalau dikunci
            isDragging = true;
            startDragX = e.touches[0].clientX;
            startDragY = e.touches[0].clientY;
            startCamX = camX;
            startCamY = camY;
        });

        canvas.addEventListener('touchmove', e => {
            if (!isDragging) return;
            const dx = e.touches[0].clientX - startDragX;
            const dy = e.touches[0].clientY - startDragY;
            
            // Geser kamera berlawanan arah jari
            camX = startCamX - dx;
            camY = startCamY - dy;
            redraw();
        });

        canvas.addEventListener('touchend', () => { isDragging = false; });

        // --- UTILS ---
        function addMarker(icon, label) {
            if (!isRecording && path.length === 0) return alert("Belum ada jalur!");
            // Simpan posisi marker di posisi player saat ini
            markers.push({ x: playerX, y: playerY, icon: icon, label: label });
            redraw();
        }

        function updateStats() {
            document.getElementById('dist-display').innerText = Math.round(totalDistance);
            // Rumus: Jarak / 0.75m
            document.getElementById('step-display').innerText = Math.floor(totalDistance / STEP_LENGTH);
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2 - lat1) * Math.PI/180;
            const dLon = (lon2 - lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function saveImage() {
            // Render ulang sekali untuk memastikan legend bersih
            redraw();
            const link = document.createElement('a');
            link.download = 'Peta_Nuswantara_V2.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>


