<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunda Sonic Modem</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --accent: #00e676; /* Alien Green */
            --text: #ffffff;
            --send: #00bcd4;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .comm-device {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h2 {
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
            margin-top: 0;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
        }

        /* Screen Area */
        .screen {
            background: #000;
            border: 2px solid #333;
            height: 200px;
            padding: 10px;
            overflow-y: auto;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            box-shadow: inset 0 0 20px rgba(0, 230, 118, 0.1);
        }

        .msg-recv { color: var(--accent); align-self: flex-start; }
        .msg-sent { color: var(--send); align-self: flex-end; text-align: right; }
        .sys-msg { color: #555; font-size: 0.8rem; text-align: center; margin: 5px 0; }

        /* Controls */
        .controls {
            display: flex;
            gap: 5px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 15px;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
            font-family: inherit;
        }

        button {
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }

        #btn-send { background: var(--send); color: black; }
        #btn-listen { background: var(--panel); color: var(--accent); border: 1px solid var(--accent); width: 100%; }
        
        #btn-listen.listening {
            background: var(--accent);
            color: black;
            animation: pulse 1s infinite;
        }

        .settings {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #777;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .status-bar {
            height: 5px;
            background: #333;
            width: 100%;
            margin-top: 5px;
        }
        .status-signal {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.1s;
        }

    </style>
</head>
<body>

    <div class="comm-device">
        <h2>Sonic Data Link</h2>
        
        <button id="btn-listen" onclick="toggleListen()">AKTIFKAN PENERIMA (MIC)</button>
        <div class="status-bar"><div class="status-signal" id="signal-meter"></div></div>

        <div class="screen" id="chat-screen">
            <div class="sys-msg">Sistem Siap. Gunakan volume tinggi untuk mengirim.</div>
        </div>

        <div class="settings">
            <span>Speed: 20 WPM</span>
            <span>Freq: 600Hz</span>
        </div>

        <div class="controls">
            <input type="text" id="msg-input" placeholder="Ketik Pesan..." onkeypress="handleEnter(event)">
            <button id="btn-send" onclick="sendMessage()">KIRIM</button>
        </div>
    </div>

    <script>
        // --- MORSE LOGIC ---
        const morseCode = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', '1': '.----', '2': '..---', '3': '...--',
            '4': '....-', '5': '.....', '6': '-....', '7': '--...', '8': '---..',
            '9': '----.', '0': '-----', ' ': '/'
        };
        const revMorse = Object.entries(morseCode).reduce((acc, [char, code]) => ({...acc, [code]: char}), {});

        // --- AUDIO CONFIG ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const freq = 600; // Nada Tit/Tat
        const unitTime = 60; // Kecepatan (makin kecil makin ngebut, tapi makin rawan error)
        
        // Sender Variables
        let oscillator = null;
        
        // Receiver Variables
        let analyser, microphone, listenLoop;
        let isListening = false;
        let historyVol = [];
        let signalState = false; // false=quiet, true=beep
        let signalStart = 0;
        let signalEnd = 0;
        let currentSequence = ""; // nyimpen .-..
        let silenceStart = 0;

        // --- UI ---
        const screen = document.getElementById('chat-screen');
        const input = document.getElementById('msg-input');
        const meter = document.getElementById('signal-meter');
        const btnListen = document.getElementById('btn-listen');

        function log(text, type) {
            const div = document.createElement('div');
            div.className = type;
            div.innerText = text;
            screen.appendChild(div);
            screen.scrollTop = screen.scrollHeight;
        }

        function handleEnter(e) {
            if(e.key === 'Enter') sendMessage();
        }

        // --- SENDER (TX) ---
        function sendMessage() {
            const text = input.value.toUpperCase().trim();
            if(!text) return;

            log("ME: " + text, 'msg-sent');
            input.value = '';

            // Convert text to timing sequence
            // dot = 1 unit, dash = 3 units
            // space parts = 1 unit, space letters = 3 units, space words = 7 units
            let timeline = [];
            let currentTime = audioCtx.currentTime + 0.5; // Start in 0.5s

            for (let char of text) {
                if (char === ' ') {
                    currentTime += (unitTime * 7) / 1000;
                    continue;
                }
                
                const code = morseCode[char];
                if (!code) continue;

                for (let symbol of code) {
                    let duration = (symbol === '.' ? 1 : 3) * unitTime / 1000;
                    
                    // Add Beep Event
                    playTone(currentTime, duration);
                    
                    currentTime += duration;
                    currentTime += (unitTime * 1) / 1000; // Inter-symbol pause
                }
                currentTime += (unitTime * 3) / 1000; // Inter-letter pause
            }
        }

        function playTone(start, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.frequency.value = freq;
            osc.type = 'sine';
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            // Envelope biar gak 'klik'
            gain.gain.setValueAtTime(0, start);
            gain.gain.linearRampToValueAtTime(1, start + 0.01);
            gain.gain.setValueAtTime(1, start + duration - 0.01);
            gain.gain.linearRampToValueAtTime(0, start + duration);
            
            osc.start(start);
            osc.stop(start + duration + 0.05);
        }


        // --- RECEIVER (RX) ---
        async function toggleListen() {
            if (isListening) {
                isListening = false;
                btnListen.classList.remove('listening');
                btnListen.innerText = "AKTIFKAN PENERIMA (MIC)";
                if(microphone) microphone.disconnect();
                cancelAnimationFrame(listenLoop);
                return;
            }

            try {
                // Resume Context if locked
                if(audioCtx.state === 'suspended') await audioCtx.resume();

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.5;
                
                microphone.connect(analyser); // Connect mic to analyser ONLY (biar gak feedback)
                
                isListening = true;
                btnListen.classList.add('listening');
                btnListen.innerText = "MENDENGARKAN...";
                
                detectLoop();

            } catch (err) {
                alert("Butuh akses Mikrofon: " + err);
            }
        }

        function detectLoop() {
            if(!isListening) return;

            const buffer = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(buffer);

            // Simple energy detection at target freq
            // 600Hz in 48kHz sample rate with fft 512
            // Bin index = Freq * FFT / SampleRate
            // Index approx = 600 * 512 / 48000 = ~6.4
            
            // Kita ambil rata-rata energy aja biar gampang (Threshold Volume)
            let vol = 0;
            for(let b of buffer) vol += b;
            vol = vol / buffer.length;

            meter.style.width = Math.min(vol * 2, 100) + "%";

            // Threshold Logic
            const threshold = 20; // Sesuaikan sensitivitas
            const now = Date.now();

            if (vol > threshold) {
                if (!signalState) {
                    // Signal Start
                    signalState = true;
                    signalStart = now;
                    // Cek durasi diam sebelumnya (spasi)
                    checkSilence(now - silenceStart);
                }
                silenceStart = now; // Reset silence timer saat bunyi
            } else {
                if (signalState) {
                    // Signal End
                    signalState = false;
                    const dur = now - signalStart;
                    decodeSignal(dur);
                }
                
                // Live check for long silence (End of message)
                if (now - silenceStart > unitTime * 15 && currentSequence.length > 0) {
                     translateChar(); // Force translate sisa karakter
                }
            }

            listenLoop = requestAnimationFrame(detectLoop);
        }

        function decodeSignal(duration) {
            // Dot vs Dash logic
            // Dot = 1 unit (approx 60ms)
            // Dash = 3 units (approx 180ms)
            // Kasih toleransi
            
            let symbol = "";
            if (duration < unitTime * 2) { 
                symbol = "."; 
            } else {
                symbol = "-";
            }
            currentSequence += symbol;
        }

        function checkSilence(duration) {
            // 3 units silence = Huruf baru
            // 7 units silence = Spasi kata
            
            if (duration > unitTime * 6) {
                translateChar();
                log(" ", 'recv-part'); // Spasi visual (opsional)
            } else if (duration > unitTime * 2.5) {
                translateChar();
            }
        }

        function translateChar() {
            if (currentSequence === "") return;
            
            const char = revMorse[currentSequence];
            if (char) {
                // Tampilkan karakter ke layar
                const lastMsg = screen.lastElementChild;
                if(lastMsg && lastMsg.classList.contains('msg-recv') && !lastMsg.dataset.done) {
                    lastMsg.innerText += char;
                } else {
                    const div = document.createElement('div');
                    div.className = 'msg-recv';
                    div.innerText = "RX: " + char;
                    screen.appendChild(div);
                }
                screen.scrollTop = screen.scrollHeight;
            }
            currentSequence = "";
        }

    </script>
</body>
</html>