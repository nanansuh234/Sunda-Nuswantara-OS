<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nuswantara Navigator</title>
    <style>
        body {
            background-color: #000;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            margin: 0; overflow: hidden; touch-action: none;
        }

        /* HUD ATAS */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0, 20, 0, 0.9); padding: 10px;
            border-bottom: 2px solid #00ff88; z-index: 20;
            display: flex; justify-content: space-between;
            box-sizing: border-box;
        }
        .hud-val { font-weight: bold; color: #fff; font-size: 1.1rem; }

        /* HUD BAWAH (MENU) */
        .hud-bottom {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 500px;
            background: rgba(0, 30, 10, 0.95);
            border: 1px solid #00ff88; border-radius: 50px;
            padding: 10px; display: flex; gap: 8px; overflow-x: auto;
            z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            scrollbar-width: none;
        }
        .hud-bottom::-webkit-scrollbar { display: none; }

        button {
            background: #002211; color: #00ff88; border: 1px solid #00ff88;
            padding: 10px 15px; font-weight: bold; white-space: nowrap;
            font-family: inherit; font-size: 0.8rem; border-radius: 30px;
        }
        button:active { background: #00ff88; color: #000; }
        
        /* Tombol Spesial */
        #btn-rec.recording { background: #ff0000; color: white; animation: pulse 1.5s infinite; border-color: red; }
        .mode-active { background: #00ff88 !important; color: #000 !important; }
        
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.5;} 100% {opacity:1;} }

        /* SLIDER KONTROL (ZOOM & OPACITY) */
        .controls-panel {
            position: absolute; bottom: 190px; left: 50%; transform: translateX(-50%);
            width: 80%; background: rgba(0,0,0,0.8); padding: 10px;
            border: 1px solid #555; border-radius: 10px; display: none; z-index: 50;
            color: #fff; font-size: 0.8rem;
        }
        input[type=range] { width: 100%; margin: 5px 0; }

        #fileInput { display: none; }
        #canvas-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050505; }
        #status-msg {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px; border: 2px solid #ff3333; 
            text-align: center; display: none; z-index: 30; color: #fff; width: 80%;
        }

        /* File Upload Label style as button */
        .file-btn {
            background: #004455; color: #00ccff; border: 1px solid #00ccff;
            padding: 10px 15px; border-radius: 30px; font-weight: bold; font-size: 0.8rem;
            display: inline-block; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="hud-top">
        <div>GPS: <span id="gps-acc" class="hud-val">OFF</span></div>
        <div>DIST: <span id="dist-val" class="hud-val">0</span>m</div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="mapCanvas"></canvas>
    </div>

    <div class="controls-panel" id="map-controls">
        <div style="display:flex; justify-content:space-between;">
            <span>üîç SKALA PETA</span> <span id="scale-txt">1.0x</span>
        </div>
        <input type="range" id="scaleSlider" min="0.1" max="5.0" step="0.01" value="1.0" oninput="updateMapParams()">
        
        <div style="display:flex; justify-content:space-between; margin-top:5px;">
            <span>üëª TRANSPARANSI</span>
        </div>
        <input type="range" id="opacitySlider" min="0.1" max="1.0" step="0.1" value="0.5" oninput="updateMapParams()">
        <small style="color:#aaa; display:block; text-align:center; margin-top:5px;">Geser layar untuk pasang posisi Peta</small>
    </div>

    <div id="status-msg"></div>

    <div class="hud-bottom">
        <label for="fileInput" class="file-btn">üìÇ LOAD PETA</label>
        <input type="file" id="fileInput" accept="image/*" onchange="handleFile(this)">

        <button id="btn-rec" onclick="toggleRecord()">START GPS</button>
        
        <button id="btn-edit-map" onclick="toggleMapEdit()" style="display:none;">üõ†Ô∏è ATUR PETA</button>
        
        <button onclick="clearPath()" style="background:#330000; border-color:#550000; color:#ff8888;">üóëÔ∏è RESET</button>
    </div>

    <script>
        // --- CONFIG ---
        const METER_TO_PIXEL = 4; // Zoom standard GPS
        const MIN_MOVE = 2;
        
        // --- STATE ---
        let isRecording = false;
        let isMapEditMode = false; // False = Geser Camera, True = Geser Gambar Peta
        let watchId = null;
        
        // GPS Data
        let startGeo = null;
        let lastGeo = null;
        let playerX = 0, playerY = 0; // Posisi Player (Meter converted to pixel)
        let path = [];
        let totalDist = 0;

        // Map Image Data
        let mapImg = null;
        let mapParams = { x: 0, y: 0, scale: 1.0, opacity: 0.5 };
        
        // Camera View
        let camX = 0, camY = 0;

        // --- SETUP ---
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            redraw();
        }
        window.addEventListener('resize', resize);
        resize();

        // --- FILE UPLOAD ---
        function handleFile(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mapImg = new Image();
                    mapImg.onload = function() {
                        // Reset map position to center
                        mapParams.x = 0;
                        mapParams.y = 0;
                        mapParams.scale = 1.0;
                        
                        // Aktifkan tombol edit
                        document.getElementById('btn-edit-map').style.display = 'block';
                        // Otomatis masuk mode edit biar user langsung pas-in
                        setMapEditMode(true);
                        redraw();
                    }
                    mapImg.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // --- GPS LOGIC ---
        function toggleRecord() {
            const btn = document.getElementById('btn-rec');
            if (!isRecording) {
                if (!navigator.geolocation) return alert("No GPS");
                
                isRecording = true;
                btn.classList.add('recording');
                btn.innerText = "STOP";
                
                // Matikan mode edit peta pas mulai jalan biar gak kegeser gak sengaja
                setMapEditMode(false);

                const opt = { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 };
                watchId = navigator.geolocation.watchPosition(updatePos, handleErr, opt);
                
                showMsg("MENCARI SATELIT...", "green");
            } else {
                isRecording = false;
                btn.classList.remove('recording');
                btn.innerText = "START GPS";
                navigator.geolocation.clearWatch(watchId);
                showMsg(null);
            }
        }

        function updatePos(pos) {
            showMsg(null);
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const acc = pos.coords.accuracy;
            document.getElementById('gps-acc').innerText = "¬±" + Math.round(acc) + "m";

            if (!startGeo) {
                startGeo = { lat, lon };
                lastGeo = { lat, lon };
                return;
            }

            const dist = getDist(lastGeo.lat, lastGeo.lon, lat, lon);
            if (dist >= MIN_MOVE) {
                totalDist += dist;
                document.getElementById('dist-val').innerText = Math.round(totalDist);

                // Convert LatLon to Pixels relative to Start
                const dLat = lat - startGeo.lat;
                const dLon = lon - startGeo.lon;
                const metersY = dLat * 111320;
                const metersX = dLon * 111320 * Math.cos(startGeo.lat * (Math.PI/180));

                playerX = metersX * METER_TO_PIXEL;
                playerY = -metersY * METER_TO_PIXEL;

                path.push({x: playerX, y: playerY});
                lastGeo = { lat, lon };
                redraw();
            }
        }

        // --- VISUAL LOGIC ---
        function toggleMapEdit() {
            setMapEditMode(!isMapEditMode);
        }

        function setMapEditMode(active) {
            isMapEditMode = active;
            const btn = document.getElementById('btn-edit-map');
            const panel = document.getElementById('map-controls');
            
            if (active) {
                btn.classList.add('mode-active');
                panel.style.display = 'block';
                btn.innerText = "‚úÖ SELESAI";
            } else {
                btn.classList.remove('mode-active');
                panel.style.display = 'none';
                btn.innerText = "üõ†Ô∏è ATUR PETA";
            }
        }

        function updateMapParams() {
            mapParams.scale = parseFloat(document.getElementById('scaleSlider').value);
            mapParams.opacity = parseFloat(document.getElementById('opacitySlider').value);
            document.getElementById('scale-txt').innerText = mapParams.scale + "x";
            redraw();
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Camera Logic: Player selalu di tengah layar
            // Kecuali lagi mode Edit Peta, kamera diem biar enak geser petanya
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            // Hitung offset rendering
            // Jika mode edit peta, kita abaikan posisi player sebentar biar fokus ke peta
            const renderOffsetX = cx - playerX;
            const renderOffsetY = cy - playerY;

            // 1. DRAW UPLOADED MAP (BACKGROUND)
            if (mapImg) {
                ctx.save();
                ctx.globalAlpha = mapParams.opacity;
                
                // Logic Peta: Peta punya koordinat sendiri (mapParams.x, y) relatif terhadap dunia
                // Kita gambar peta supaya ikut bergerak saat player jalan
                
                const imgW = mapImg.width * mapParams.scale;
                const imgH = mapImg.height * mapParams.scale;
                
                // Koordinat Peta di Layar = (Posisi Peta di Dunia) + (Kompensasi Kamera)
                const drawX = mapParams.x + renderOffsetX;
                const drawY = mapParams.y + renderOffsetY;

                // Center point gambar ada di koordinat mapParams
                ctx.drawImage(mapImg, drawX - imgW/2, drawY - imgH/2, imgW, imgH);
                
                ctx.restore();
                
                // Crosshair pembantu saat mode edit
                if (isMapEditMode) {
                    ctx.strokeStyle = "yellow";
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(cx, 0); ctx.lineTo(cx, canvas.height);
                    ctx.moveTo(0, cy); ctx.lineTo(canvas.width, cy);
                    ctx.stroke();
                    
                    ctx.fillStyle = "yellow";
                    ctx.fillText("GESER LAYAR UNTUK PASANG POSISI PETA", cx + 10, cy - 10);
                }
            } else {
                // Kalau gak ada peta, gambar grid
                drawGrid(renderOffsetX, renderOffsetY);
            }

            // 2. DRAW PATH
            if (path.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 3;
                ctx.moveTo(path[0].x + renderOffsetX, path[0].y + renderOffsetY);
                for (let i = 1; i < path.length; i++) ctx.lineTo(path[i].x + renderOffsetX, path[i].y + renderOffsetY);
                ctx.stroke();
            }

            // 3. DRAW PLAYER
            ctx.fillStyle = "#fff";
            ctx.beginPath(); ctx.arc(cx, cy, 6, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = "#fff"; ctx.beginPath(); ctx.arc(cx, cy, 15, 0, Math.PI*2); ctx.stroke();
        }
        
        function drawGrid(ox, oy) {
            ctx.fillStyle = "#222";
            for(let x = ox%50; x<canvas.width; x+=50) 
                for(let y = oy%50; y<canvas.height; y+=50) ctx.fillRect(x,y,2,2);
        }

        // --- TOUCH INTERACTION ---
        let isDragging = false;
        let startTx, startTy;
        let startMapX, startMapY;

        canvas.addEventListener('touchstart', e => {
            isDragging = true;
            startTx = e.touches[0].clientX;
            startTy = e.touches[0].clientY;
            
            if (isMapEditMode) {
                startMapX = mapParams.x;
                startMapY = mapParams.y;
            }
        });

        canvas.addEventListener('touchmove', e => {
            if (!isDragging) return;
            e.preventDefault();
            const dx = e.touches[0].clientX - startTx;
            const dy = e.touches[0].clientY - startTy;

            if (isMapEditMode && mapImg) {
                // Geser Peta (Kalibrasi)
                // Peta digeser menjauh/mendekat relatif terhadap player
                mapParams.x = startMapX + dx;
                mapParams.y = startMapY + dy;
            } else {
                // Mode Navigasi Biasa (Kalau mau free look bisa ditambahin disini)
            }
            redraw();
        });

        canvas.addEventListener('touchend', () => isDragging = false);

        // --- UTILS ---
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2 - lat1) * Math.PI/180;
            const dLon = (lon2 - lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function handleErr(err) { showMsg("GPS ERROR: " + err.message, "red"); }
        function showMsg(txt, color) {
            const el = document.getElementById('status-msg');
            if(!txt) { el.style.display='none'; return; }
            el.innerHTML = txt; el.style.display='block'; el.style.borderColor = color || "#fff";
        }
        function clearPath() {
             if(confirm("Reset semua jalur?")) { path=[]; totalDist=0; redraw(); }
        }
    </script>
</body>
</html>