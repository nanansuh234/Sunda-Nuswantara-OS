<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StegaVault v3.2 (Fixed)</title>
    <style>
        /* TEMA CYBERPUNK CYAN */
        body {
            background-color: #00090d;
            color: #00f7ff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        h1 { text-shadow: 0 0 10px #00f7ff; margin-bottom: 5px; letter-spacing: 2px;}
        .subtitle { color: #008c91; font-size: 0.8rem; margin-bottom: 25px; }

        .container {
            width: 100%; max-width: 650px;
            background: #001417; border: 1px solid #00383b;
            padding: 20px; border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 247, 255, 0.1);
        }

        /* TABS */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #00383b; }
        .tab-btn {
            flex: 1; padding: 15px; background: #001f24;
            border: none; color: #008c91; cursor: pointer;
            font-weight: bold; font-family: inherit; transition: 0.3s;
        }
        .tab-btn.active { background: #00383b; color: #00f7ff; box-shadow: inset 0 -3px 0 #00f7ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* INPUTS */
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #008c91; }
        input, textarea {
            width: 100%; background: #00090d; color: #00f7ff;
            border: 1px solid #00383b; padding: 12px; border-radius: 5px;
            margin-bottom: 20px; font-family: inherit; box-sizing: border-box;
        }
        input[type="file"] { padding: 10px; background: #001f24; cursor: pointer; }
        textarea { height: 100px; resize: vertical; }
        input:focus, textarea:focus { outline: none; border-color: #00f7ff; }
        
        .password-group { border: 1px solid #00f7ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; background: rgba(0, 247, 255, 0.05); }

        button.action-btn {
            width: 100%; padding: 15px; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; font-family: inherit;
            font-size: 1.1rem; transition: 0.2s;
            background: #00f7ff; color: #00090d;
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.3);
        }
        button.action-btn:hover { background: #ccfcff; box-shadow: 0 0 25px rgba(0, 247, 255, 0.5); }
        button:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        #previewImg { max-width: 100%; margin-bottom: 20px; border: 1px solid #00383b; display: none;}
        
        .status { margin-top: 15px; text-align: center; color: #008c91; font-size: 0.9rem; font-weight: bold;}
        .warning { font-size: 0.7rem; color: #ffcc00; margin-top: 10px; text-align: center;}

        /* Canvas disembunyikan */
        #processCanvas { display: none; }
    </style>
</head>
<body>

    <h1>STEGAVAULT</h1>
    <div class="subtitle">QUANTUM IMAGE STEGANOGRAPHY v3.2</div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('hide')">üîí HIDE (Sembunyikan)</button>
            <button class="tab-btn" onclick="switchTab('reveal')">üîì REVEAL (Tampilkan)</button>
        </div>

        <div id="hideTab" class="tab-content active">
            <label>1. PILIH GAMBAR WADAH (JPG/PNG):</label>
            <input type="file" id="coverImageInput" accept="image/png, image/jpeg">
            <img id="previewImg" alt="Preview">

            <label>2. PESAN RAHASIA:</label>
            <textarea id="secretMessage" placeholder="Tulis pesan yang akan disusupkan..."></textarea>

            <div class="password-group">
                <label>3. PASSWORD ENKRIPSI (Wajib):</label>
                <input type="password" id="hidePassword" placeholder="Kunci pengaman pesan">
            </div>

            <button id="btnHide" class="action-btn" onclick="hideProcess()">INJECT & DOWNLOAD PNG</button>
            <p class="warning">‚ö†Ô∏è PENTING: Kirim hasil gambar via WA sebagai DOKUMEN.</p>
        </div>

        <div id="revealTab" class="tab-content">
            <label>1. PILIH GAMBAR STEGANOGRAFI (.PNG):</label>
            <input type="file" id="stegaImageInput" accept="image/png">

            <div class="password-group" style="margin-top: 20px;">
                <label>2. PASSWORD PEMBUKA:</label>
                <input type="password" id="revealPassword" placeholder="Password harus sama persis">
            </div>

            <button id="btnReveal" class="action-btn" style="background: #008c91; color: #fff;" onclick="revealProcess()">EXTRACT MESSAGE</button>

            <label style="margin-top: 25px;">HASIL PESAN:</label>
            <textarea id="revealedOutput" readonly placeholder="Pesan muncul di sini..."></textarea>
        </div>

        <div class="status" id="statusMsg">System Standby.</div>
    </div>

    <canvas id="processCanvas"></canvas>

    <script>
        // === UI FUNCTIONS ===
        function switchTab(mode) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if(mode === 'hide') {
                document.querySelector('button[onclick="switchTab(\'hide\')"]').classList.add('active');
                document.getElementById('hideTab').classList.add('active');
            } else {
                document.querySelector('button[onclick="switchTab(\'reveal\')"]').classList.add('active');
                document.getElementById('revealTab').classList.add('active');
            }
            setStatus("System Standby.");
        }

        function setStatus(msg, isError = false) {
            const s = document.getElementById('statusMsg');
            s.innerText = msg;
            s.style.color = isError ? '#ff3333' : '#008c91';
        }

        // Preview Image Handling
        document.getElementById('coverImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.getElementById('previewImg');
                    img.src = event.target.result;
                    img.style.display = 'block';
                    setStatus("Image loaded. Ready.");
                }
                reader.readAsDataURL(file);
            }
        });

        // === CRYPTO HELPER ===
        async function getCryptoKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
            return window.crypto.subtle.deriveKey({name:"PBKDF2", salt:salt, iterations:100000, hash:"SHA-256"}, keyMaterial, {name:"AES-GCM", length:256}, false, ["encrypt", "decrypt"]);
        }

        // === STEGANOGRAPHY CORE ===
        
        // HIDE PROCESS
        async function hideProcess() {
            // FIX TYPO HERE: fileInput (sambung)
            const fileInput = document.getElementById('coverImageInput');
            const text = document.getElementById('secretMessage').value;
            const password = document.getElementById('hidePassword').value;
            const btn = document.getElementById('btnHide');
            
            if(!fileInput.files[0]) { setStatus("‚ö†Ô∏è Pilih Gambar Dulu!", true); return; }
            if(!text) { setStatus("‚ö†Ô∏è Isi Pesan Rahasia Dulu!", true); return; }
            if(!password) { setStatus("‚ö†Ô∏è Isi Password Dulu!", true); return; }

            btn.disabled = true;
            btn.innerText = "‚è≥ PROCESSING...";
            setStatus("Encrypting & Injecting...");

            try {
                // 1. ENCRYPT MESSAGE
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const key = await getCryptoKey(password, salt);
                const enc = new TextEncoder();
                const encryptedBuf = await window.crypto.subtle.encrypt({name:"AES-GCM", iv:iv}, key, enc.encode(text));

                // Data Structure: SALT(16) + IV(12) + DATA + STOPPER(8)
                const stopper = new Uint8Array([0,0,0,0,0,0,0,0]); 
                const dataToHide = new Uint8Array(salt.length + iv.length + encryptedBuf.byteLength + stopper.length);
                dataToHide.set(salt, 0);
                dataToHide.set(iv, 16);
                dataToHide.set(new Uint8Array(encryptedBuf), 28);
                dataToHide.set(stopper, 28 + encryptedBuf.byteLength);

                // 2. DRAW IMAGE TO CANVAS
                // Kita pakai gambar yang sudah muncul di preview biar aman
                const imgElement = document.getElementById('previewImg');
                if (!imgElement.complete || imgElement.naturalWidth === 0) {
                    throw new Error("Gambar belum selesai dimuat. Coba pilih ulang.");
                }

                const canvas = document.getElementById('processCanvas');
                canvas.width = imgElement.naturalWidth;
                canvas.height = imgElement.naturalHeight;
                const ctx = canvas.getContext('2d', {willReadFrequently: true});
                ctx.drawImage(imgElement, 0, 0);

                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imgData.data;

                // Check Capacity
                if (dataToHide.length * 8 > pixels.length / 4 * 3) {
                     throw new Error("Pesan terlalu panjang untuk gambar sekecil ini!");
                }

                // 3. INJECT BITS (LSB)
                let dataIndex = 0;
                let bitIndex = 0;
                
                // Sedikit delay biar browser gak hang kalau gambar gede
                await new Promise(r => setTimeout(r, 50));

                for (let i = 0; i < pixels.length; i += 4) { 
                    if (dataIndex >= dataToHide.length) break;
                    
                    for (let j = 0; j < 3; j++) { // R, G, B
                         if (dataIndex >= dataToHide.length) break;
                         
                         let byte = dataToHide[dataIndex];
                         let bit = (byte >> (7 - bitIndex)) & 1;
                         
                         pixels[i+j] = (pixels[i+j] & 0xFE) | bit;
                         
                         bitIndex++;
                         if(bitIndex == 8) { bitIndex = 0; dataIndex++; }
                    }
                }

                ctx.putImageData(imgData, 0, 0);
                
                // 4. DOWNLOAD
                setStatus("‚úÖ DONE! Downloading...");
                const link = document.createElement('a');
                link.download = "STEGA_SECURE_" + Date.now() + ".png";
                link.href = canvas.toDataURL("image/png");
                link.click();
                
                btn.innerText = "INJECT & DOWNLOAD PNG";
                btn.disabled = false;

            } catch (e) {
                console.error(e);
                alert("ERROR: " + e.message);
                setStatus("‚ùå Gagal: " + e.message, true);
                btn.innerText = "INJECT & DOWNLOAD PNG";
                btn.disabled = false;
            }
        }

        // REVEAL PROCESS
        async function revealProcess() {
            const fileInput = document.getElementById('stegaImageInput');
            const password = document.getElementById('revealPassword').value;
            const output = document.getElementById('revealedOutput');
            const btn = document.getElementById('btnReveal');

            if(!fileInput.files[0]) { setStatus("‚ö†Ô∏è Pilih file gambar dulu!", true); return; }
            if(!password) { setStatus("‚ö†Ô∏è Masukan password!", true); return; }

            btn.disabled = true;
            btn.innerText = "‚è≥ DECODING...";
            output.value = "";
            setStatus("Extracting...");

            try {
                // Load image manually
                const img = new Image();
                img.src = URL.createObjectURL(fileInput.files[0]);
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                });
                
                const canvas = document.getElementById('processCanvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d', {willReadFrequently: true});
                ctx.drawImage(img, 0, 0);
                
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imgData.data;

                // Extract Bits
                let extractedBits = [];
                // Kita batasi pembacaan biar gak memory leak kalau gak ketemu stopper
                const maxBytes = 100000; // Maksimal baca 100KB pesan (cukup banget)
                const limit = maxBytes * 8; 
                
                for (let i = 0; i < pixels.length; i += 4) {
                    if (extractedBits.length > limit) break; 
                    for (let j = 0; j < 3; j++) {
                        extractedBits.push(pixels[i+j] & 1);
                    }
                }

                // Bits to Bytes
                let extractedBytes = new Uint8Array(Math.floor(extractedBits.length / 8));
                for (let i = 0; i < extractedBytes.length; i++) {
                    let byteVal = 0;
                    for (let j = 0; j < 8; j++) {
                        byteVal = (byteVal << 1) | extractedBits[i*8 + j];
                    }
                    extractedBytes[i] = byteVal;
                }

                // Find Stopper
                let stopperIndex = -1;
                for(let i=28; i < extractedBytes.length - 8; i++) {
                    if(extractedBytes.slice(i, i+8).every(b => b === 0)) {
                        stopperIndex = i;
                        break;
                    }
                }

                if(stopperIndex === -1) throw new Error("Tidak ditemukan pesan tersembunyi (atau gambar rusak/dikompres WA).");

                const salt = extractedBytes.slice(0, 16);
                const iv = extractedBytes.slice(16, 28);
                const encryptedData = extractedBytes.slice(28, stopperIndex);

                setStatus("Decrypting...");
                const key = await getCryptoKey(password, salt);
                const decryptedBuf = await window.crypto.subtle.decrypt({name:"AES-GCM", iv:iv}, key, encryptedData);
                
                const dec = new TextDecoder();
                output.value = dec.decode(decryptedBuf);
                
                setStatus("‚úÖ PESAN TERBUKA!");
                btn.innerText = "EXTRACT MESSAGE";
                btn.disabled = false;

            } catch (e) {
                console.error(e);
                output.value = "GAGAL!\n\nKemungkinan:\n1. Password Salah.\n2. Gambar bukan format StegaVault.\n3. Gambar dikirim via 'Send Image' WA (Harus Document).";
                setStatus("‚ùå Gagal membuka pesan.", true);
                btn.innerText = "EXTRACT MESSAGE";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>